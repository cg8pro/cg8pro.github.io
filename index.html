<!DOCTYPE html>
<html lang="en">
<head>
    <title>cg8.pro 画室</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="normalize.css" rel="stylesheet" type="text/css" />
    <link href="skeleton.css" rel="stylesheet" type="text/css" />
    <link href="custom.css" rel="stylesheet" type="text/css" />
    <link href="font-face.css" rel="stylesheet" type="text/css" />
    <link rel="icon" type="image/png" href="favicon.png">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-image: url('./draw_bg.png');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
        }
    </style>
    <script type="text/javascript">
        function checkCookie(name) {
            var cookies = document.cookie.split("; ");
            for(var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].split("=");
                if(cookie[0] === name) {
                    return true;
                }
            }
            return false;
        }

        function getCookie(name) {
          const cookies = document.cookie.split("; ");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].split("=");
            if (cookie[0] === name) {
              return decodeURIComponent(cookie[1]);
            }
          }
          return null;
        }        

        window.onload = function() {
            if(!checkCookie("MJPROXY_TOKEN")) {
                window.location.href = "auth.html";
            }
        }
    </script>
</head>
<body>
    <header class="site-header" style="background-color: white;opacity: 0.7;">
        <div class="wrapper">
            <nav class="site-nav">
                <div class="trigger">
                    <!--<a class="page-link" href="">千万艺术家</a>-->
                    <a class="page-link" href="index.html">“中途旅行”</a>
                    <a class="page-link" href="heaven.html">里世界</a>
                    <a class="page-link" href="about.html">关于我</a>               
                </div>
            </nav>
        </div>
    </header>    
    <div class="section" style="margin-top:2%">
        <div class="container">
            <h3 class="section-heading" style="font-family:pixel;color:white;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;"> 画点什么？</h3>
            <img id="img" style="box-shadow: 4px 4px 8px 0px #fff000, -4px -4px 8px 0px #ff0000;"></img>
            <div>
                <label class="three columns" style="font-family:pixel;font-size:20px;color:white;text-align: left;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;">提示词：</label>
                <meter class="eight columns" id="meter" style="margin-left: 0px; margin-top:5px;" min="0" max="60" value="60"></meter>
                <label id="countdownLable" style="font-family:pixel;font-size:20px;color:white;text-align: center;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;">></label>
            </div>             
            <textarea id="prompt" class="u-full-width" style="font-family:pixel;font-size:20px;"></textarea>
            <button id="draw" style="font-family: pixel;font-size: 20px;color:white;float: right;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;">开炮</button>
            
        </div>
    </div>
    <script src="jquery.min.js"></script>
    <script src="forge.min.js"></script>
    <script>
        $(document).ready(function(){
            $('#meter')[0].style.display = "none"
            $('#countdownLable')[0].style.display = "none"
            $("#countdownLable").html(seconds);

            var countdown;
            var seconds = 60;

            function startCountdown() {
                $('#countdown').text(seconds);
                countdown = setInterval(function() {
                    seconds--;
                    $('#countdown').text(seconds);
                    $('#meter')[0].value = seconds;
                    $("#countdownLable").html(seconds);
                    if (seconds <= 0) {
                        clearInterval(countdown);
                    }
                }, 1000);
            }

            function stopCountdown() {
                clearInterval(countdown);
                $('#countdown').text('倒计时结束');
            }

            $('#draw').click(function(){
                $('#draw').prop("disabled", true);
                $('#draw').text("生成中...");
                $('#meter')[0].style.display = "block"
                $('#countdownLable')[0].style.display = "block"
                $("#countdownLable").html(seconds);
                startCountdown();
                $.ajax({
                    url: "https://mjproxy.azurewebsites.net/api/mjproxy",
                    type: "POST",
                    data: {
                        "prompt": $("#prompt").val(), 
                        "op": "Imagine", 
                        "token": getCookie("MJPROXY_TOKEN"),
                        "mjmessage":""
                    }, 
                    contentType: 'application/json',
                    success: function(response) {
                        var resp = JSON.parse(response);
                        $("#img").attr("src", resp.base64img);
                        $('#draw').prop("disabled", false);
                        $('#draw').text("开炮");
                        $('#meter')[0].style.display = "none"
                        $('#countdownLable')[0].style.display = "none"
                        seconds = 60;
                        stopCountdown();
                    },
                    error: function(xhr, status, error) {
                        console.error("请求出错: " + error);
                        $('#draw').prop("disabled", false);
                        $('#draw').text("开炮");
                        $('#meter')[0].style.display = "none"
                        $('#countdownLable')[0].style.display = "none"
                        seconds = 60;
                        stopCountdown();
                    }
                });
            });
        });

    </script>
</body>
</html>