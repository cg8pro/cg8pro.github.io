<!DOCTYPE html>
<html lang="en">
<head>
    <title>Simple GPT</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/header.css" rel="stylesheet" type="text/css" />
    <link href="../style/chatgpt.css" rel="stylesheet" type="text/css" />
    <link href="../img/favicon.png" rel="icon" type="image/png">
</head>
<body>
    <header class="site-header" style="background-color: white;opacity: 0.7;">
        <div class="wrapper">
            <a class="site-title" href="">CG8 Simple GPT</a>
            <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="about.html">ğŸ‘‰ğŸ‘‰ğŸ‘‰ è”ç³»æˆ‘ ğŸ‘ˆğŸ‘ˆğŸ‘ˆ</a>        
                </div>
            </nav>
        </div>
    </header>
    <div class="container" style="margin-top:2%">
        <div style="text-align: center; margin-bottom: 20px;">
            <div class="row" >ã€è‡ªåŠ¨è”ç½‘æœç´¢ã€‘ã€æ— éœ€æ³¨å†Œã€‘ã€æ— é™å¤šå¼€ã€‘ã€å½“å‰æ¨¡å‹ï¼š<span style="color: red;">GPT-4</span>ã€‘</div>
            <div class="row" style="color: RGB(150,150,150)">ä¿å­˜å³ä¸‹è§’ä¼šè¯idï¼Œéšæ—¶æ¢å¤èŠå¤©è®°å½•ï¼Œä¹Ÿå¯åˆ†äº«å¯¹è¯ç»™å…¶ä»–äººã€‚è§¦å‘è”ç½‘ä¼šå¢åŠ çº¦60ç§’å“åº”æ—¶é—´</div>
        </div>
        <div class="row">
            <meter class="twelve columns" id="meter" style="margin-left: 0px; margin-top:5px;display: none;" min="0" max="120" value="120"></meter>
            <label style="display: none;" id="countdownLable"></label>
        </div>
        <div class="row">
            <!--<div class="two columns" style="min-height: 632px;border-radius: 10px;border: 1px solid rgb(222,222,222);" >

            </div>-->
            <!--<div class="ten columns"  >-->
                <div id="chatbox" class="row" style="min-height: 500px;max-height:500px;overflow-y:scroll;padding: 15px;border-radius: 10px;border: 1px solid rgb(222,222,222);">

                </div>
                <div class="row">
                    <textarea id="say" class="u-full-width" placeholder="" style="min-height: 80px; margin: 20px auto 0 auto;"></textarea>
                    <span style="color: rgb(180,180,180);float: left">&nbsp;è¾“å…¥æ¶ˆæ¯ ã€Ctrl + å›è½¦ã€‘&nbsp;å‘é€&nbsp; / &nbsp;è¾“å…¥ä¼šè¯id ã€Alt + å›è½¦ã€‘&nbsp;åŠ è½½èŠå¤©è®°å½•</span>
                    <button id="copyButton" style="float:right;height:25px;line-height: 25px;margin: 0 5px 0 5px;">å¤åˆ¶</button>
                    <span id="session" style="float: right;color: RGB(50,205,50)"></span>
                </div>
            <!--</div>-->
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/forge.min.js"></script>
    <script>
        var countdown;
        var seconds = 120;

        window.onload = function() {
            var messages = [];
            var textarea = document.getElementById("say");
            var chatbox = document.getElementById("chatbox");
            const currentsession = document.getElementById("session");
            textarea.addEventListener('keydown', (event) => {
                if(event.key === 'Enter' && event.ctrlKey) {
                    //var countdownLable = document.getElementById("countdownLable")
                    var meter = document.getElementById("meter")
                    //countdownLable.style.display = "block"
                    meter.style.display = "block"
                    //countdownLable.innerHTML = seconds;
                    startCountdown();

                    event.preventDefault();
                    message = {"role":"user","content":textarea.value}
                    messages.push(message)
                    fillChatbox(messages);
                    setTimeout(function() {
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }, 0);
                    fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                "option": "7",
                                "messages": encrypt(key,iv,new TextEncoder().encode(JSON.stringify(message))),
                                "session": currentsession.innerHTML,
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            //countdownLable.style.display = "none"
                            meter.style.display = "none"
                            //countdownLable.innerHTML = seconds;
                            seconds = 120;
                            stopCountdown();

                            console.log(data)
                            if(data.cptCnt == 0) {
                                messages.pop();
                            }else{
                                currentsession.innerHTML = data.session
                                messages = messages.concat(JSON.parse(decrypt(key,iv,data.message)))
                                fillChatbox(messages)
                                textarea.value = ''
                                setTimeout(function() {
                                    chatbox.scrollTop = chatbox.scrollHeight;
                                }, 0);
                            }
                        })
                        .catch(error => {
                            console.error(error);  
                    });                    
                }
                if(event.key === 'Enter' && event.altKey) {
                    //var countdownLable = document.getElementById("countdownLable")
                    var meter = document.getElementById("meter")
                    //countdownLable.style.display = "block"
                    meter.style.display = "block"
                    //countdownLable.innerHTML = seconds;
                    startCountdown();

                    event.preventDefault();
                    fillChatbox(messages);
                    fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                "option": "1",
                                "messages": encrypt(key,iv,new TextEncoder().encode(JSON.stringify([]))),
                                "session": textarea.value
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            //countdownLable.style.display = "none"
                            meter.style.display = "none"
                            //countdownLable.innerHTML = seconds;
                            seconds = 120;
                            stopCountdown();
                            
                            console.log(data)
                            if(data.cptCnt == 0) {
                                messages.pop();
                            }else{
                                messages.length = 0;
                                currentsession.innerHTML = textarea.value
                                JSON.parse(decrypt(key,iv,data.message)).forEach(item => {
                                    messages.push(item);                               
                                })
                                fillChatbox(messages)
                                textarea.value = ''
                                setTimeout(function() {
                                    chatbox.scrollTop = chatbox.scrollHeight;
                                }, 0);
                            }
                        })
                        .catch(error => {
                            console.error(error);  
                    });                                     
                }
            });
            document.querySelector("#copyButton").addEventListener('click', function() {
                copySpanTextToClipboard('session');
            });
        }
        function fillChatbox(messages){
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = "";
            messages.forEach(msg => {

                const msgLine = document.createElement('div');
                msgLine.classList.add('msgLine')
                const msgtext = document.createElement('div');
                if(msg.role === 'user') {
                    msgtext.classList.add('user-msg');
                } else if(msg.role === 'assistant') {
                    msgtext.classList.add('assistant-msg');
                }      

                const contentBlocks = parseContent(msg.content);
                contentBlocks.forEach(block => {
                    if (block.type === 'code') {
                        // æ¸²æŸ“ä»£ç å— 
                        const pre = document.createElement('pre');
                        const code = document.createElement('code');
                        pre.style.color = 'black';
                        code.textContent = block.content;
                        pre.appendChild(code);
                        msgtext.appendChild(pre);
                    } else {
                        // æ¸²æŸ“æ™®é€šæ–‡æœ¬å—
                        const span = document.createElement('span');
                        span.innerHTML = block.content;
                        msgtext.appendChild(span);
                    }
                });

                msgLine.appendChild(msgtext)
                chatbox.appendChild(msgLine)
            });
        }
        function parseContent(content) {
            let blocks = [];
            let lines = content.split('\n');
            let inCode = false;
            let text = '';
            let code = '';
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                if (line.startsWith('```') && !inCode) {
                    // æ–‡æœ¬å—ç»“æŸæˆ–ä»£ç å—å¼€å§‹
                    if (text) {
                        blocks.push({type: 'text', content: text});
                        text = '';
                    }
                    inCode = !inCode;
                } else if (line.endsWith('```') && inCode) {
                    // ä»£ç å—ç»“æŸ
                    inCode = false;
                    blocks.push({type: 'code', content:code});
                    code = '';
                } else {
                    if (inCode) {
                        // ç§¯ç´¯ä»£ç å†…å®¹
                        code += line + '\n';
                    } else { 
                        // ç§¯ç´¯æ–‡æœ¬å†…å®¹  
                        text += line + '\n';
                    }
                }
            }
            // æ”¶å°¾ 
            if (text) 
                blocks.push({type: 'text', content: text});
            return blocks;
        }
        function copySpanTextToClipboard(spanId) {
            var span = document.getElementById(spanId);
            var text = span.textContent;
            var tempTextarea = document.createElement('textarea');
            tempTextarea.style = "position: absolute; left: -1000px; top: -1000px";
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            if(text.length > 0){
                alert("ä¼šè¯idå·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
            }
        }
        function startCountdown() {
            countdown = setInterval(function() {
                seconds--;
                $('#meter')[0].value = seconds;
                //$("#countdownLable").html(seconds);
                if (seconds <= 0) {
                    clearInterval(countdown);
                }
            }, 1000);
        }

        function stopCountdown() {
            clearInterval(countdown);
            $('#countdown').text('å€’è®¡æ—¶ç»“æŸ');
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // åŠ å¯†
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({iv: iv});
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // è§£å¯†
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({iv: iv});
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }

    </script>
</body>
</html>