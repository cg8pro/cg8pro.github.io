<!DOCTYPE html>
<html lang="en">
<head>
    <title>cg8.pro ç”»å®¤</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/custom.css" rel="stylesheet" type="text/css" />
    <link href="../img/favicon.png" rel="icon" type="image/png">
    <script type="text/javascript">
        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent)) {
            link.href = '../style/draw_bg_mobile.css';
        } else {
            link.href = '../style/draw_bg.css';
        }        
        document.head.appendChild(link);  

        var link = document.createElement('link');
        link.rel = 'stylesheet';
        link.type = 'text/css';
        if(/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent)) {
        } else {
            link.href = '../style/font-face.css';
            document.head.appendChild(link); 
        }        
        

        function checkCookie(name) {
            var cookies = document.cookie.split("; ");
            for(var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].split("=");
                if(cookie[0] === name) {
                    return true;
                }
            }
            return false;
        }

        function getCookie(name) {
          const cookies = document.cookie.split("; ");
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].split("=");
            if (cookie[0] === name) {
              return decodeURIComponent(cookie[1]);
            }
          }
          return null;
        } 

        window.onload = function() {
            if(!checkCookie("MJPROXY_TOKEN")) {
                window.location.href = "auth.html";
            }
        }
    </script>
</head>
<body>
    <header class="site-header" style="background-color: white;opacity: 0.7;">
        <div class="wrapper">
            <nav class="site-nav">
                <div class="trigger">
                    <a class="page-link" href="gallery.html">åƒä¸‡è‰ºæœ¯å®¶</a>
                    <a class="page-link" href="playground.html">ç”»å®¤</a>
                    <a class="page-link" href="about.html">å…³äº</a>                 
                </div>
            </nav>
        </div>
    </header>    
    <div class="section" style="margin-top:2%">
        <div class="container">
            <h4 class="section-heading" style="font-family:pixel;color:lightpink;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;"> ç”»ç‚¹ä»€ä¹ˆï¼Ÿ</h4>
            <img id="img" style="box-shadow: 4px 4px 8px 0px #fff000, -4px -4px 8px 0px #ff0000;"></img>
            <div style="display: block;">
                <button id="upscale1" style="color:white;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;display: none;">æ”¾å¤§å·¦ä¸Šè§’</button>
                <button id="upscale2" style="color:white;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;display: none;">æ”¾å¤§å³ä¸Šè§’</button>
                <button id="upscale3" style="color:white;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;display: none;">æ”¾å¤§å·¦ä¸‹è§’</button>
                <button id="upscale4" style="color:white;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;display: none;">æ”¾å¤§å³ä¸‹è§’</button>
            </div>
            <div>
                <label class="three columns" style="font-family:pixel;font-size:20px;color:lightpink;text-align: left;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;">æç¤ºè¯ï¼š</label>
                <meter class="eight columns" id="meter" style="margin-left: 0px; margin-top:5px;" min="0" max="120" value="120"></meter>
                <label id="countdownLable" style="font-family:pixel;font-size:20px;color:lightpink;text-align: center;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;"></label>
            </div>             
            <textarea id="prompt" class="u-full-width" style="font-family:pixel;font-size:20px;"></textarea>
            <select id="sample" style="width: 45%;height: 36px;font-size: 16px;color: #FFF;border: 1px solid #ccc;background-color: rgb(111,120,134,0.4);float: left;">
                <option value="" disabled selected>æç¤ºè¯æ¨¡æ¿ï¼ˆæ ¹æ®è‡ªå·±çš„éœ€è¦ä¿®æ”¹å…³é”®å­—ï¼‰</option>
                <option value="png white background, [tech leader], in the style of animated illustrations, [city skyline], full body, text-based --stylize 20">èŒåœºç”Ÿäº§åŠ› - PPTç´ æ - å•†ä¸šç²¾è‹±</option>
                <option value="line art icon of a [envelope] --stylize 10">èŒåœºç”Ÿäº§åŠ› - PPTå›¾æ ‡ - ä¿¡å°å›¾æ ‡</option>
                <option value="[Timon the Meerkat from the movie The Lion King] as a Sticker, Sticker, high quality press sticker, vinyl sticker --style raw --s 1000 --s 750">äº§å“è®¾è®¡ - Qç‰ˆè´´çº¸</option>
                <option value="van gogh's starry night --s 750 --ar 4:3">è‰ºæœ¯ - å¤§å¸ˆä¸´æ‘¹ - æ¢µé«˜Â·æ˜Ÿç©º</option>
                <option value="[ice age scene] kirigami art --s 750">è‰ºæœ¯ - å›½ç²¹ - å‰ªçº¸</option>
                <option value="Happy Cute hoodie baby toddler holding the letter X::2 simple background, soft colors, 3D, octane rendering --niji --style expressive --s 750">å¤´åƒ - 3Dæ‰‹åŠ</option>
            </select>
            <button id="draw" style="font-family: pixel;font-size: 20px;color:lightpink;float: right;text-shadow: 2px 2px 4px #000, -2px -2px 4px #F00;">>>å¼€å§‹ç»˜åˆ¶<<</button>

        </div>
        <div class="container" style="background-color: rgb(173,194,185,0.5);padding: 5px 5px 10px 5px; border-radius: 10px;">
            <div class="slider" style="width:150px;float: left;margin-left: 20px;" >
                <input style="margin-top:10px;" type="range" min="1" max="5" value="1" class="slider" id="arRange"/>
                <span class="arValue" disabled>1:1</span>
            </div>
            <div class="slider" style="width:150px;float: left;margin-left: 20px;">
                <input style="margin-top:10px;" type="range" min="1" max="5" value="1" class="slider" id="sRange"/>
                <span class="sValue" disabled>å¹³å‡¡</span>
            </div>
            <div class="slider" style="width:150px;float: left;margin-left: 20px;">
                <input style="margin-top:10px;" type="range" min="1" max="5" value="1" class="slider" id="cRange"/>
                <span class="cValue" disabled>ç¨³å®š</span>
            </div>       
            <div class="slider" style="width:150px;float: left;margin-left: 20px;">
                <input style="margin-top:10px;" type="range" min="1" max="5" value="1" class="slider" id="wRange"/>
                <span class="wValue" disabled>åˆç†</span>
            </div>              
            <div class="slider" style="width:150px;float: left;margin-left: 20px;">
                <input style="margin-top:10px;" type="range" min="1" max="2" value="1" class="slider" id="nRange"/>
                <span class="nValue" disabled>Nijiå…³</span>
            </div>  
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/forge.min.js"></script>
    <script>
        var mjmessage;
        $(document).ready(function(){
            $('#meter')[0].style.display = "none"
            $('#countdownLable')[0].style.display = "none"
            $("#countdownLable").html(seconds);

            var countdown;
            var seconds = 120;

            function startCountdown() {
                $('#countdown').text(seconds);
                countdown = setInterval(function() {
                    seconds--;
                    $('#countdown').text(seconds);
                    $('#meter')[0].value = seconds;
                    $("#countdownLable").html(seconds);
                    if (seconds <= 0) {
                        clearInterval(countdown);
                    }
                }, 1000);
            }

            function stopCountdown() {
                clearInterval(countdown);
                $('#countdown').text('å€’è®¡æ—¶ç»“æŸ');
            }

            function calculateImageSize(width, height, X) {
              let newWidth, newHeight;
              // åˆ¤æ–­æ˜¯æ¨ªå›¾è¿˜æ˜¯ç«–å›¾ï¼Œç„¶åç›¸åº”åœ°è®¡ç®—æ–°å°ºå¯¸
              if (width > height) {
                // æ¨ªå›¾: ä»¥é«˜åº¦ä¸ºåŸºå‡†
                const aspectRatio = width / height;
                newWidth = X * aspectRatio;
                newHeight = X;
              } else {
                // ç«–å›¾: ä»¥å®½åº¦ä¸ºåŸºå‡†
                const aspectRatio = height / width;
                newHeight = X * aspectRatio;
                newWidth = X;
              }
              
              return {
                width: newWidth,
                height: newHeight
              };
            }

            function upscale(target){
                $('#upscale1')[0].style.display = "none";
                $('#upscale2')[0].style.display = "none";
                $('#upscale3')[0].style.display = "none";
                $('#upscale4')[0].style.display = "none"; 
                $('#draw').prop("disabled", true);
                $('#draw').text("ç”Ÿæˆä¸­...");
                $('#meter')[0].style.display = "block"
                $('#countdownLable')[0].style.display = "block"
                $("#countdownLable").html(seconds);
                startCountdown();
                $.ajax({
                    url: "https://mjproxy.azurewebsites.net/api/mjproxy",
                    type: "POST",
                    data: {
                        "prompt": $('#prompt').val() + " " + arPrompt + " " + chaosPrompt + " " + stylizePrompt + " " + weirdPrompt + " " + nijiPrompt,
                        "op": "Upscale", 
                        "target": target,
                        "token": getCookie("MJPROXY_TOKEN"),
                        "mjmessage": btoa(JSON.stringify(mjmessage).replace("ğŸ”„","reroll"))
                    }, 
                    contentType: 'application/json',
                    success: function(response) {
                        var resp = JSON.parse(response);
                        if (resp.mjmessage !== undefined && resp.mjmessage.width !== undefined && resp.mjmessage.height !== undefined){
                            mjmessage = resp.mjmessage;
                            const newSize = calculateImageSize(resp.mjmessage.width, resp.mjmessage.height, 512);
                            $('img').css({
                              'width': `${newSize.width}px`,
                              'height': `${newSize.height}px`
                            });                            
                        }

                        $("#img").attr("src", resp.base64img);
                        $('#draw').prop("disabled", false);
                        $('#draw').text(">>å¼€å§‹ç»˜åˆ¶<<");
                        seconds = 120;
                        $('#meter')[0].style.display = "none"
                        $('#meter')[0].value = seconds;
                        $('#countdownLable')[0].style.display = "none"
                        stopCountdown();
                    },
                    error: function(xhr, status, error) {
                        console.error("è¯·æ±‚å‡ºé”™: " + error);
                        $('#draw').prop("disabled", false);
                        $('#draw').text(">>å¼€å§‹ç»˜åˆ¶<<");
                        seconds = 120;
                        $('#countdownLable')[0].style.display = "none"
                        $('#meter')[0].style.display = "none"
                        $('#meter')[0].value = seconds;
                        stopCountdown();
                    }
                });
            }

            $("#upscale1").click(function() {
                upscale("U1");
            });
            $("#upscale2").click(function() {
                upscale("U2");
            });
            $("#upscale3").click(function() {
                upscale("U3");
            });
            $("#upscale4").click(function() {
                upscale("U4");
            });        

            $('#niji').click(function(){
                $('#nijiChosen').html("--niji 5" + "   [&times;]")
                $('#nijiChosen').val("--niji 5")
            })        
            $('#nijiChosen').click(function(){
                $('#nijiChosen').html("")
                $('#nijiChosen').val("")
            })                                            


            $("#sample").change(function() {
                $("#prompt").val($(this).val());
            });

            $('#draw').click(function(){
                $('#draw').prop("disabled", true);
                $('#draw').text("ç”Ÿæˆä¸­...");
                $('#meter')[0].style.display = "block"
                $('#countdownLable')[0].style.display = "block"
                $("#countdownLable").html(seconds);
                var finalPrompt = $('#prompt').val() + " " + arPrompt + " " + chaosPrompt + " " + stylizePrompt + " " + weirdPrompt + " " + nijiPrompt;
                //$("#prompt").val(finalPrompt)
                startCountdown();
                $.ajax({
                    url: "https://mjproxy.azurewebsites.net/api/mjproxy",
                    type: "POST",
                    data: {
                        "prompt": finalPrompt,
                        "op": "Imagine", 
                        "token": getCookie("MJPROXY_TOKEN"),
                        "mjmessage":""
                    }, 
                    contentType: 'application/json',
                    success: function(response) {
                        var resp = JSON.parse(response);
                        if (resp.mjmessage !== undefined && resp.mjmessage.width !== undefined && resp.mjmessage.height !== undefined){
                            mjmessage = resp.mjmessage;
                            const newSize = calculateImageSize(resp.mjmessage.width, resp.mjmessage.height, 512);
                            $('img').css({
                              'width': `${newSize.width}px`,
                              'height': `${newSize.height}px`
                            });             

                            $('#upscale1')[0].style.display = "inline-block";
                            $('#upscale2')[0].style.display = "inline-block";
                            $('#upscale3')[0].style.display = "inline-block";
                            $('#upscale4')[0].style.display = "inline-block";         
                        }

                        $("#img").attr("src", resp.base64img);
                        $('#draw').prop("disabled", false);
                        $('#draw').text(">>å¼€å§‹ç»˜åˆ¶<<");
                        seconds = 120;
                        $('#meter')[0].style.display = "none"
                        $('#meter')[0].value = seconds;
                        $('#countdownLable')[0].style.display = "none"
                        stopCountdown();
                    },
                    error: function(xhr, status, error) {
                        console.error("è¯·æ±‚å‡ºé”™: " + error);
                        $('#draw').prop("disabled", false);
                        $('#draw').text(">>å¼€å§‹ç»˜åˆ¶<<");
                        seconds = 120;
                        $('#meter')[0].style.display = "none"
                        $('#meter')[0].value = seconds;
                        $('#countdownLable')[0].style.display = "none"
                        stopCountdown();
                    }
                });
            });

            const arValuesAlias = ['1:1','4:3', '3:4', '16:9', '9:16'];
            const arValues = ['','--ar 4:3', '--ar 3:4', '--ar 16:9', '--ar 9:16'];
            const arSlider = document.getElementById("arRange");
            const arValue = document.querySelector(".arValue");
            var arPrompt = '1:1';
            arSlider.oninput = function() {
                arValue.textContent = arValuesAlias[this.value - 1] + " " + arValues[this.value - 1]; 
                arPrompt = arValues[this.value - 1];
            }

            const sValuesAlias = ['æ™®é€š','æœ‰ç‚¹è‰ºæœ¯', 'ç¨å¾®è‰ºæœ¯', 'è¾ƒä¸ºè‰ºæœ¯', 'ç‰¹åˆ«è‰ºæœ¯'];
            const sValues = ['','--stylize 100', '--stylize 250', '--stylize 500', '--stylize 1000'];
            const sSlider = document.getElementById("sRange");
            const sValue = document.querySelector(".sValue");
            var stylizePrompt = '--stylize 0';
            sSlider.oninput = function() {
                sValue.textContent = sValuesAlias[this.value - 1] + " " + sValues[this.value - 1]; 
                stylizePrompt = sValues[this.value - 1]; 
            }

            const cValuesAlias = ['ç¨³å®š','å˜åŒ–', 'å¤šå˜', 'ä¸ç¨³å®š', 'æ··ä¹±'];
            const cValues = ['','--c 25', '--c 50', '--c 75', '--c 100'];
            const cSlider = document.getElementById("cRange");
            const cValue = document.querySelector(".cValue");
            var chaosPrompt = '--c 0';
            cSlider.oninput = function() {
                cValue.textContent = cValuesAlias[this.value - 1] + " " + cValues[this.value - 1]; 
                chaosPrompt = cValues[this.value - 1]; 
            }     

            const wValuesAlias = ['åˆç†','å¥‡æ€ª', 'è¯¡å¼‚', 'ç–¯ç‹‚', 'å§æ§½'];
            const wValues = ['','--weird 250', '--weird 750', '--weird 1000', '--weird 3000'];
            const wSlider = document.getElementById("wRange");
            const wValue = document.querySelector(".wValue");
            var weirdPrompt = '--weird 0'
            wSlider.oninput = function() {
                wValue.textContent = wValuesAlias[this.value - 1] + " " + wValues[this.value - 1]; 
                weirdPrompt = wValues[this.value - 1]; 
            }                

            const nValuesAlias = ['Nijiå…³','Nijiå¼€'];
            const nValues = ['','--niji 5'];
            const nSlider = document.getElementById("nRange");
            const nValue = document.querySelector(".nValue");
            var nijiPrompt = '';
            nSlider.oninput = function() {
                nValue.textContent = nValuesAlias[this.value - 1] + " " + nValues[this.value - 1]; 
                nijiPrompt = nValues[this.value - 1]; 
            }            
        });

    </script>
</body>
</html>