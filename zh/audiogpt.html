<!DOCTYPE html>
<html>

<head>
    <title>Talk GPT cg8.pro</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/audiogpt.css" rel="stylesheet" type="text/css" />
</head>

<body style="background-color: black;">
    <header>
        <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            Talk GPT by <span style="color: rgb(26,173,26);"><a href="#" id="modal-trigger" style="color: rgb(26,173,26);">CG8</a>👈️</span>
        </div>
    </header>
    <div class="container main">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="assistant" class="assistant" src="../img/silent.gif" />
        </div>

    </div>
    <div class="footer">
        <div style="text-align: center; ">
            <img id="record" class="press" src="../img/btn_ready.gif" />
        </div>
        <span id="tips" style="color: white;font-size: 18px;display: none;"></span>
    </div>
    <!-- 模态框 -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>打造专属业务场景TalkGPT</p>
            <p>截图二维码，微信扫一扫联系我</p>
            <img style="width: 90%;" src="../img/wechat2.jpg" alt="cg8 二维码">
            <p>更多：</p>
            <p>GPT接入实战教程</p>
            <p>身份出海攻略</p>
        </div>
    </div>
    <script src="../js/forge.min.js"></script>
    <!--<script src="../js/vconsole.min.js"></script>-->
    <script src="../js/recorder.js"></script>
    <script>
        //var vConsole = new window.VConsole();
        let mediaRecorder;
        let audioChunks = [];
        let messages = [];
        let audioContext, source, recorder, stream;
        let isRecording = false; var monitorVar = false;
        var recordButton = document.getElementById('record');
        var assistant = document.getElementById('assistant');
        var gpt = document.getElementById("assistant");
        var tips = document.getElementById("tips")

        // 点击录音按钮后的操作
        recordButton.addEventListener('click', function () {
            if (!isRecording) {
                recordButton.src = '../img/btn_collecting.gif';
                recordButton.style.width = '100px'
                gpt.src = "../img/speaking.gif"
                isRecording = true;

                // Step 1: 从麦克风中获取音频流
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function (mediaStream) {
                        stream = mediaStream;
                        audioContext = new AudioContext();
                        source = audioContext.createMediaStreamSource(stream);
                        recorder = new Recorder(source);

                        // 开始录音
                        recorder.record();
                        isRecording = true;
                    })
                    .catch(function (err) {
                        console.log('获取音频流失败：' + err);
                    });
            } else {
                recordButton.src = '../img/nospeak.gif';
                recordButton.style.width = '100px'
                recordButton.style.visibility = 'hidden'
                tips.style.display = "inline"
                tips.innerHTML = "你的声音正在赛博宇宙中回荡···"
                gpt.src = "../img/thinking.gif"

                // 停止录音
                recorder.stop();
                isRecording = false;

                // Step 2: 发送音频数据到服务器
                recorder.exportWAV(function (blob) {

                    // 将blob转为base64
                    let reader = new FileReader();
                    reader.onloadend = function () {
                        const base64AudioMessage = reader.result.split(',')[1];
                        console.log(base64AudioMessage);

                        fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                                "actlike": "default",
                                "audio": base64AudioMessage,
                                "option": "6",
                                "voice": "onyx"
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                var resultMessages = JSON.parse(decrypt(key, iv, data.message));
                                messages.push(...resultMessages);
                                console.log(messages);

                                // 将 Base64 编码的字符串转换为 bytes
                                var byteCharacters = atob(data.audio);
                                var byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                var byteArray = new Uint8Array(byteNumbers);

                                // Decode audio data with audio context
                                audioContext.decodeAudioData(byteArray.buffer, buffer => {

                                    let source = audioContext.createBufferSource();
                                    source.buffer = buffer;

                                    // 连接图：音源 -> 输出（扬声器）
                                    source.connect(audioContext.destination);

                                    source.onended = function () {
                                        assistant.src = '../img/silent.gif';
                                        recordButton.src = '../img/btn_ready.gif'
                                        recordButton.style.visibility = 'visible'
                                    };

                                    assistant.src = '../img/speaking.gif';
                                    tips.style.display = "none"
                                    // 播放音频
                                    source.start();
                                });
                            });
                    }

                    reader.readAsDataURL(blob);
                });
            }
        });

        // 获取模态框链接，模态框元素，和关闭按钮元素
        var modalTrigger = document.getElementById('modal-trigger');
        var modal = document.getElementById('myModal');
        var closeBtn = document.getElementsByClassName('close')[0];

        // 点击链接时打开模态框
        modalTrigger.addEventListener('click', function (event) {
            event.preventDefault();
            modal.style.display = 'block';
        });

        // 点击关闭按钮或者模态框外部时，关闭模态框
        closeBtn.onclick = function () {
            modal.style.display = 'none';
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // 加密
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // 解密
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>