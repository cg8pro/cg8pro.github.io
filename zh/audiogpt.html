<!DOCTYPE html>
<html>

<head>
    <title>Talk GPT cg8.pro</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/audiogpt.css" rel="stylesheet" type="text/css" />
</head>

<body style="background-color: black;">
    <header>
        <!-- <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            Talk GPT by <span style="color: rgb(26,173,26);"><a href="#" id="modal-trigger"
                    style="color: rgb(26,173,26);">CG8</a>ğŸ‘ˆï¸</span>
        </div> -->
        <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            &nbsp;&nbsp;<span style="color: rgb(26,173,26);"><a href="#" id="modal-trigger"
                    style="color: rgb(26,173,26);"></a></span>
        </div>
    </header>
    <div class="container main">
        <div id="userSpeakingCircle" class="userSpeakingCircle"></div>
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="assistantThinkingCircle" class="assistant" src="../img/gptThinking.gif" style="display: none;" />
        </div>

        <div id="gptSpeaking" style="display: none;">
            <div class="gptAudioBox"></div>
            <div class="gptAudioBox"></div>
            <div class="gptAudioBox"></div>
            <div class="gptAudioBox"></div>
        </div>
    </div>
    <div class="footer">
        <div id="userSpeaking" style="display: none;">
            <div style="font-size: 30px;line-height: 25px;color:white;">
                <svg width="25" height="25" fill="currentColor" class="bi bi-mic-fill" viewBox="0 0 16 16">
                    <path d="M5 3a3 3 0 0 1 6 0v5a3 3 0 0 1-6 0V3z" />
                    <path
                        d="M3.5 6.5A.5.5 0 0 1 4 7v1a4 4 0 0 0 8 0V7a.5.5 0 0 1 1 0v1a5 5 0 0 1-4.5 4.975V15h3a.5.5 0 0 1 0 1h-7a.5.5 0 0 1 0-1h3v-2.025A5 5 0 0 1 3 8V7a.5.5 0 0 1 .5-.5z" />
                </svg>
            </div>
            <div class="userAudioBox"></div>
            <div class="userAudioBox"></div>
            <div class="userAudioBox"></div>
            <div class="userAudioBox"></div>
        </div>
        <span id="guide" style="color: white;background-color: transparent;">Start speaking</span>
        <div style="text-align: center;margin-top: 30px;">
            <img id="record" class="press" src="../img/btn_ready.gif" style="background-color: transparent;" />
        </div>
        <span id="tips" style="color: white;font-size: 18px;display: none;"></span>
    </div>
    <!-- æ¨¡æ€æ¡† -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>æ‰“é€ ä¸“å±ä¸šåŠ¡åœºæ™¯TalkGPT</p>
            <p>æˆªå›¾äºŒç»´ç ï¼Œå¾®ä¿¡æ‰«ä¸€æ‰«è”ç³»æˆ‘</p>
            <img style="width: 90%;" src="../img/wechat2.jpg" alt="cg8 äºŒç»´ç ">
            <p>æ›´å¤šï¼š</p>
            <p>GPTæ¥å…¥å®æˆ˜æ•™ç¨‹</p>
            <p>èº«ä»½å‡ºæµ·æ”»ç•¥</p>
        </div>
    </div>
    <div id="introModal" class="modal">
        <div class="modal-content">
            <p style="color: green;font-size: 24px;"><strong>è¿™æ˜¯ä»€ä¹ˆ</strong></p>
            <p>chatgpt éŸ³é¢‘é€šè¯ç‰ˆ</p>
            <p style="color:green;font-size: 24px;"><strong>æ€ä¹ˆç©</strong></p>
            <p>1 ç‚¹å‡»å°ç™½ç‚¹ï¼Œæˆæƒéº¦å…‹é£</p>
            <p>2 è¯´ç‚¹ä»€ä¹ˆï¼Œæ¯”å¦‚â€œä½ å¥½â€ï¼Œç­‰å¾…å›å¤</p>
            <p>3 å¹³å‡éœ€è¦ç­‰å¾…10ç§’</p>
            <span class="intro-close"
                style="color: red;border: 1px solid white;padding: 8px;border-radius: 10px;">å¥½çš„ï¼Œæˆ‘çŸ¥é“äº†</span>
        </div>
    </div>
    <script src="../js/forge.min.js"></script>
    <!--<script src="../js/vconsole.min.js"></script>-->
    <script src="../js/recorder.js"></script>
    <script>
        //var vConsole = new window.VConsole();
        let mediaRecorder, recorder, audioContext, source, stream, volumeCheckIntervalId;
        let messages = [];
        var isResponsing = false; // ç”¨äºæ ‡è¯†ç”¨æˆ·æ˜¯å¦ç‚¹å‡»äº†å°ç™½ç‚¹å¼€å§‹å¯¹è¯
        var isGptResponsing = false; // ç”¨äºæ ‡è¯†å½“å‰æ˜¯å¦ä¸ºç­‰å¾…GPTå“åº”æˆ–GPTæ­£åœ¨å“åº”çš„çŠ¶æ€ï¼Œä»¥ç”¨æ¥å±è”½éº¦å…‹é£åœ¨è¿™æ®µæ—¶é—´çš„æ´»åŠ¨æ€§
        var recordButton = document.getElementById('record');
        var assistantThinking = document.getElementById('assistantThinkingCircle');
        var userSpeaking = document.getElementById("userSpeakingCircle");
        var assistantSpeaking = document.getElementById('gptSpeaking');
        var userAudio = document.getElementById('userSpeaking');
        var tips = document.getElementById("tips")
        var guide = document.getElementById("guide")

        window.onload = function () {
            // è·å–æ¨¡æ€æ¡†é“¾æ¥ï¼Œæ¨¡æ€æ¡†å…ƒç´ ï¼Œå’Œå…³é—­æŒ‰é’®å…ƒç´ 
            var introModal = document.getElementById('introModal');
            var introCloseBtn = document.getElementsByClassName('intro-close')[0];
            introModal.style.display = 'block';

            // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–è€…æ¨¡æ€æ¡†å¤–éƒ¨æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†
            introCloseBtn.onclick = function () {
                introModal.style.display = 'none';
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            }
            window.onclick = function (event) {
                if (event.target == introModal) {
                    introModal.style.display = 'none';
                }
            }
        }

        // ç‚¹å‡»å½•éŸ³æŒ‰é’®åçš„æ“ä½œ
        recordButton.addEventListener('click', function () {
            if (isResponsing) {
                clearInterval(volumeCheckIntervalId);
                recordButton.src = '../img/btn_ready.gif'
                console.log(recordButton)
                userAudio.style.display = "none"
                isResponsing = false;
                guide.innerHTML = "Start speaking"
                return;
            } else {
                recordButton.src = '../img/cancel.png'
                userAudio.style.display = 'flex'
                isResponsing = true;
            }

            // Step 1: ä»éº¦å…‹é£ä¸­è·å–éŸ³é¢‘æµ
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (mediaStream) {
                    stream = mediaStream;
                    audioContext = new AudioContext();
                    source = audioContext.createMediaStreamSource(stream);

                    var recorder = new Recorder(source);
                    var analyser = audioContext.createAnalyser();
                    source.connect(analyser)
                    var dataArray = new Uint8Array(analyser.frequencyBinCount);
                    // åˆå§‹åŒ–æ²¡æœ‰è¶…è¿‡30çš„éŸ³é‡çš„æŒç»­æ—¶é—´å’Œè¶…è¿‡30ä¹‹åæ²¡æœ‰å†è¶…è¿‡30çš„æŒç»­æ—¶é—´
                    let threshold = 170; // éŸ³é«˜å³°å€¼é˜ˆå€¼
                    let recording = false; // æ˜¯å¦æ­£åœ¨å½•éŸ³
                    let peakDetected = false; // ä¸Šæ¬¡æ£€æµ‹æ˜¯å¦å‘ç°äº†éŸ³é«˜å³°å€¼
                    let durationSinceLastPeak = 0; // ä¸Šæ¬¡éŸ³é«˜å³°å€¼åçš„æ—¶é—´
                    let durationSinceStart = 0; // å½•éŸ³å¯åŠ¨åçš„æŒç»­æ—¶é—´
                    let peakOccurred = false; // æ˜¯å¦åœ¨å½•éŸ³å¯åŠ¨åå‘ç°è¿‡éŸ³é«˜å³°å€¼

                    recorder = new Recorder(source);
                    recorder.record();
                    recording = true;

                    volumeCheckIntervalId = setInterval(function () {
                        analyser.getByteFrequencyData(dataArray);
                        let peaks = [];
                        for (let i = 0; i < dataArray.length; i++) {
                            if (dataArray[i] > threshold) {
                                peaks.push(i);
                            }
                        }
                        if (peaks.length > 0) {
                            peakDetected = true;
                            peakOccurred = true;
                            durationSinceLastPeak = 0;
                            //console.log("æ£€æµ‹åˆ°éŸ³é«˜å³°å€¼");
                            for (let i = 0; i < peaks.length; i++) {
                                if (!isGptResponsing) {
                                    guide.innerHTML = "Finish speaking to send"
                                    userSpeaking.style.display = "block";
                                    userAudio.style.display = "flex";
                                    userSpeakingCircle();
                                    triggerUserSpeaking();
                                }
                            }
                            if (!recording) {
                                if (!isGptResponsing) {
                                    recorder = new Recorder(source);
                                    recorder.record();
                                    recording = true;
                                }
                            }
                        } else {
                            if (peakDetected) {
                                durationSinceLastPeak += 250;
                            }
                            if (recording && durationSinceLastPeak >= 3000) {
                                guide.innerHTML = "Tap to cancel"
                                assistantThinkingCircle.style.display = "inline";
                                userSpeaking.style.display = "none";
                                userAudio.style.display = "none"
                                //console.log("å½•åˆ¶ç»“æŸ")
                                recorder.stop();
                                recording = false;
                                isGptResponsing = true;
                                recorder.exportWAV(function (blob) {

                                    // å°†blobè½¬ä¸ºbase64
                                    let reader = new FileReader();
                                    reader.onloadend = function () {
                                        const base64AudioMessage = reader.result.split(',')[1];
                                        //console.log(base64AudioMessage);

                                        fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({
                                                "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                                                "actlike": "default",
                                                "audio": base64AudioMessage,
                                                "option": "6",
                                                "voice": "onyx"
                                            })
                                        })
                                            .then(response => response.json())
                                            .then(data => {
                                                var resultMessages = JSON.parse(decrypt(key, iv, data.message));
                                                messages.push(...resultMessages);
                                                console.log(messages);

                                                // å°† Base64 ç¼–ç çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º bytes
                                                var byteCharacters = atob(data.audio);
                                                var byteNumbers = new Array(byteCharacters.length);
                                                for (let i = 0; i < byteCharacters.length; i++) {
                                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                                }
                                                var byteArray = new Uint8Array(byteNumbers);

                                                // Decode audio data with audio context
                                                audioContext.decodeAudioData(byteArray.buffer, buffer => {

                                                    let source = audioContext.createBufferSource();
                                                    source.buffer = buffer;

                                                    // è¿æ¥å›¾ï¼šéŸ³æº -> è¾“å‡ºï¼ˆæ‰¬å£°å™¨ï¼‰
                                                    source.connect(audioContext.destination);

                                                    var gainNode = audioContext.createGain();
                                                    gainNode.gain.value = 3;
                                                    source.connect(gainNode);
                                                    gainNode.connect(audioContext.destination);

                                                    source.onended = function () {
                                                        userSpeaking.style.display = "block";
                                                        userAudio.style.display = "flex";
                                                        assistantThinking.style.display = "none";
                                                        assistantSpeaking.style.display = "none";
                                                        stopGptSpeaking = true;
                                                        
                                                        isGptResponsing = false;
                                                        guide.innerHTML = "Start speaking"
                                                    };

                                                    assistantThinkingCircle.style.display = "none";
                                                    assistantSpeaking.style.display = "flex";
                                                    tips.style.display = "none";
                                                    stopGptSpeaking = false;
                                                    guide.innerHTML = "Listening";
                                                    triggerGptSpeaking();
                                                    // æ’­æ”¾éŸ³é¢‘
                                                    source.start();
                                                });
                                            });
                                    }
                                    reader.readAsDataURL(blob);
                                });
                            }
                        }

                        // éº¦å…‹é£é•¿æ—¶é—´æ— è¾“å…¥ï¼Œé‡å¯å½•åˆ¶
                        if (recording) {
                            durationSinceStart += 250;
                            if (!peakOccurred && durationSinceStart >= 3000) {
                                recorder.stop();
                                recorder.start();
                                durationSinceStart = 0;
                                peakOccurred = false;
                            }
                        }
                    }, 250);
                })
                .catch(function (err) {
                    console.log('è·å–éŸ³é¢‘æµå¤±è´¥ï¼š' + err);
                });
        });

        // è·å–æ¨¡æ€æ¡†é“¾æ¥ï¼Œæ¨¡æ€æ¡†å…ƒç´ ï¼Œå’Œå…³é—­æŒ‰é’®å…ƒç´ 
        var modalTrigger = document.getElementById('modal-trigger');
        var modal = document.getElementById('myModal');
        var closeBtn = document.getElementsByClassName('close')[0];

        // ç‚¹å‡»é“¾æ¥æ—¶æ‰“å¼€æ¨¡æ€æ¡†
        modalTrigger.addEventListener('click', function (event) {
            event.preventDefault();
            modal.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–è€…æ¨¡æ€æ¡†å¤–éƒ¨æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†
        closeBtn.onclick = function () {
            modal.style.display = 'none';
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // åŠ å¯†
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // è§£å¯†
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }

        // userSpeakingCircle åŠ¨æ•ˆ
        function userSpeakingCircle() {
            var userSpeakingCircle = document.getElementById("userSpeakingCircle")
            userSpeakingCircle.classList.remove('userSpeakingPulse');
            void userSpeakingCircle.offsetWidth; // å¼ºåˆ¶æµè§ˆå™¨å›æµå¹¶é‡ç½®åŠ¨ç”»
            userSpeakingCircle.classList.add('userSpeakingPulse');
        }

        // userSpeaking åŠ¨æ•ˆ
        let lastHeight1 = 30; // åˆå§‹é«˜åº¦

        function triggerUserSpeaking() {
            document.querySelectorAll('.userAudioBox').forEach(box => {
                // éšæœºæ”¹å˜ä¸€ç‚¹é«˜åº¦
                let change = Math.random() * 40 - 20;
                let newHeight = lastHeight1 + change;

                // ä¿è¯æ–°é«˜åº¦åœ¨100åˆ°150ä¹‹é—´
                if (newHeight < 35) newHeight = 35;
                if (newHeight > 45) newHeight = 45;

                box.style.height = `${newHeight}px`;
                lastHeight1 = newHeight;

                setTimeout(() => {
                    box.style.height = '30px';
                }, 200);
            });
        }

        // gptSpeaking åŠ¨æ•ˆ
        let lastHeight2 = 80; // åˆå§‹é«˜åº¦
        let stopGptSpeaking = false; // åœæ­¢æ ‡å¿—ï¼Œå½“è§¦å‘äº†æŸä¸ªäº‹ä»¶åï¼Œå°†è¿™ä¸ªå˜é‡è®¾ä¸ºtrueä»¥åœæ­¢å¾ªç¯
        function triggerGptSpeaking() {
            document.querySelectorAll('.gptAudioBox').forEach(box => {
                // éšæœºæ”¹å˜ä¸€ç‚¹é«˜åº¦
                let change = Math.random() * 80 - 40;
                let newHeight = lastHeight2 + change;

                // ä¿è¯æ–°é«˜åº¦åœ¨100åˆ°150ä¹‹é—´
                if (newHeight < 80) newHeight = 80;
                if (newHeight > 160) newHeight = 160;

                box.style.height = `${newHeight}px`;
                lastHeight2 = newHeight;

                setTimeout(() => {
                    box.style.height = '80px';
                }, 200);
            });

            if (!stopGptSpeaking) {
                // å¦‚æœæ²¡æœ‰è¢«åœæ­¢ï¼Œ500æ¯«ç§’åå†æ¬¡è¿è¡Œ
                setTimeout(triggerGptSpeaking, 200);
            }
        }
    </script>
</body>

</html>