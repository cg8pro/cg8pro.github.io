<!DOCTYPE html>
<html>

<head>
    <title>Talk GPT cg8.pro</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/audiogpt.css" rel="stylesheet" type="text/css" />
</head>

<body style="background-color: black;">
    <header>
        <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            Talk GPT
        </div>
    </header>
    <div class="container main">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="assistant" class="assistant" src="../img/silent.gif" />
        </div>

    </div>
    <div class="footer">
        <div style="text-align: center; ">
            <img id="record" class="press" src="../img/btn_ready.gif" />
        </div>
        <span id="tips" style="color: white;font-size: 24px;"></span>
        <div>-</div>
        <div style="color:grey;font-size: 12px;">问题复杂时思考时间长</div>
    </div>
    <script src="../js/forge.min.js"></script>
    <script src="../js/vconsole.min.js"></script>
    <script src="../js/recorder.js"></script>
    <script>
        var vConsole = new window.VConsole();
        let mediaRecorder;
        let audioChunks = [];
        let messages = [];
        var monitorVar = false;
        const recordButton = document.getElementById('record');
        const assistant = document.getElementById('assistant');
        const tips = document.getElementById("tips");
        var status = ""; // collecting sending gpting silent
        var isSpeaking = false;
        tips.innerHTML = "点击讲话"

        let audioContext, source, recorder, stream;
        let isRecording = false;

        // 点击录音按钮后的操作
        recordButton.addEventListener('click', function () {
        if (!isRecording) {
            // Step 1: 从麦克风中获取音频流
            navigator.mediaDevices.getUserMedia({ audio: true })
            .then(function(mediaStream) {
                stream = mediaStream;
                audioContext = new AudioContext();
                source = audioContext.createMediaStreamSource(stream);
                recorder = new Recorder(source);
        
                // 开始录音
                recorder.record();
                isRecording = true;
            })
            .catch(function(err) {
                console.log('获取音频流失败：' + err);
            });
        } else {
            // 停止录音
            recorder.stop();
            isRecording = false;

            // Step 2: 发送音频数据到服务器
            recorder.exportWAV(function(blob) {

            // 将blob转为base64
            let reader = new FileReader();
            reader.onloadend = function() {
                const base64AudioMessage = reader.result.split(',')[1];
                console.log(base64AudioMessage);

                fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                        "actlike": "default",
                        "audio": base64AudioMessage,
                        "option": "6",
                        "voice": "onyx"
                    })
                })
                .then(response => response.json())
                    .then(data => {
                        var resultMessages = JSON.parse(decrypt(key, iv, data.message));
                        messages.push(...resultMessages);
                        console.log(messages);

                        // 将 Base64 编码的字符串转换为 bytes
                        var byteCharacters = atob(data.audio);
                        var byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        var byteArray = new Uint8Array(byteNumbers);

                        // Decode audio data with audio context
                        audioContext.decodeAudioData(byteArray.buffer, buffer => {

                            let source = audioContext.createBufferSource();
                            source.buffer = buffer;

                            // 连接图：音源 -> 输出（扬声器）
                            source.connect(audioContext.destination);

                            source.onended = function () {
                                assistant.src = '../img/silent.gif';
                                tips.innerHTML = "点一下，然后讲话";
                                recordButton.style.display = "inline";
                            };

                            source.onplaying = function () {
                                assistant.src = '../img/speaking.gif';
                                tips.innerHTML = "GPT 正在讲话";
                            };

                            // 播放音频
                            source.start();
                        });
                    });
            }

            reader.readAsDataURL(blob);  
            });
        }
        });

        // // 创建全局轮询
        // var pollId = setInterval(function () {

        //     if (monitorVar === true) {
        //         audioContext = new (window.AudioContext || window.webkitAudioContext)();
        //         audioContext.resume().then(() => {
        //             const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
        //             //sendAudioToServer(audioBlob);
        //             clearInterval(pollId);
        //         })
        //     }
        // }, 2000);

        // navigator.mediaDevices.getUserMedia({ audio: true })
        //     .then(stream => {
        //         mediaRecorder = new MediaRecorder(stream);
        //         mediaRecorder.addEventListener("dataavailable", event => {
        //             console.log(event)
        //             audioChunks.push(event.data);
        //             console.log(audioChunks)
        //         });

        //         mediaRecorder.addEventListener("stop", () => {
        //             monitorVar = true;
        //         });
        //     });


        // recordButton.addEventListener('click', () => {
        //     if (isSpeaking) {
        //         recordButton.src = '../img/btn_ready.gif';
        //         audioChunks = [];
        //         isSpeaking = false;
        //         tips.innerHTML = ""
        //         mediaRecorder.stop();
        //     } else {
        //         recordButton.src = '../img/btn_collecting.gif';
        //         isSpeaking = true;
        //         tips.innerHTML = "你说话"
        //         mediaRecorder.start();
        //     }
        // });

        // recordButton.addEventListener('touchstart', () => {
        //     gpt.src = '../img/speak.gif';
        //     audioChunks = [];
        //     mediaRecorder.start();
        // });

        // recordButton.addEventListener('touchend', () => {
        //     gpt.src = '../img/silent.gif';
        //     mediaRecorder.stop();
        // });

        function sendAudioToServer(audioBlob) {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64AudioMessage = reader.result.split(',')[1];
                assistant.src = '../img/thinking.gif';
                tips.innerHTML = "GPT思考中······";
                recordButton.style.display = "none";
                fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                        "actlike": "default",
                        "audio": base64AudioMessage,
                        "option": "6",
                        "voice": "onyx"
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        var resultMessages = JSON.parse(decrypt(key, iv, data.message));
                        messages.push(...resultMessages);
                        console.log(messages);

                        // 将 Base64 编码的字符串转换为 bytes
                        var byteCharacters = atob(data.audio);
                        var byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        var byteArray = new Uint8Array(byteNumbers);

                        // Decode audio data with audio context
                        audioContext.decodeAudioData(byteArray.buffer, buffer => {

                            let source = audioContext.createBufferSource();
                            source.buffer = buffer;

                            // 连接图：音源 -> 输出（扬声器）
                            source.connect(audioContext.destination);

                            source.onended = function () {
                                assistant.src = '../img/silent.gif';
                                tips.innerHTML = "点一下，然后讲话";
                                recordButton.style.display = "inline";
                            };

                            source.onplaying = function () {
                                assistant.src = '../img/speaking.gif';
                                tips.innerHTML = "GPT 正在讲话";
                            };

                            // 播放音频
                            source.start();
                        });
                    });
            };
            reader.readAsDataURL(audioBlob);
        }

        function changeImage() {


        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // 加密
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // 解密
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>