<!DOCTYPE html>
<html>

<head>
    <title>Talk GPT cg8.pro</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/audiogpt.css" rel="stylesheet" type="text/css" />
</head>

<body style="background-color: black;">
    <header>
        <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            Talk GPT
        </div>
    </header>
    <div class="container main">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="assistant" class="assistant" src="../img/silent.gif" />
        </div>

    </div>
    <div class="footer">
        <div style="text-align: center; ">
            <img id="record" class="press" src="../img/btn_ready.gif" />
        </div>
        <span id="tips" style="color: white;font-size: 24px;"></span>
        <div>-</div>
        <div style="color:grey;font-size: 12px;">问题复杂时思考时间长</div>
    </div>
    <script src="../js/forge.min.js"></script>
    <script src="../js/vconsole.min.js"></script>
    <script>
        var vConsole = new window.VConsole();
        var mediaRecorder;
        var audioChunks = [];
        var messages = [];
        const recordButton = document.getElementById('record');
        const assistant = document.getElementById('assistant');
        const tips = document.getElementById("tips");
        var status = ""; // collecting sending gpting silent
        var isSpeaking = false;

        tips.innerHTML = "点击讲话"

        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.addEventListener("dataavailable", event => {
                    console.log("触发dataavailable")
                    audioChunks.push(event.data);
                });

                mediaRecorder.addEventListener("stop", () => {
                    console.log(audioChunks)
                    const audioBlob = new Blob(audioChunks, { type: 'audio/mpeg' });
                    console.log(audioBlob)
                    //sendAudioToServer(audioBlob);
                });
            });


        recordButton.addEventListener('click', async () => {
            new (window.AudioContext || window.webkitAudioContext)().resume().then(async () => {
                // 如果audioChunks和mediaRecorder没有初始化，等待它们
                while (!audioChunks || !mediaRecorder) {
                    console.log("未初始化，等待")
                    await new Promise(resolve => setTimeout(resolve, 100)); // 在下一次检查之前等待1秒
                }

                if (isSpeaking) {
                    recordButton.src = '../img/btn_ready.gif';
                    audioChunks = [];
                    isSpeaking = false;
                    tips.innerHTML = "";
                    mediaRecorder.stop();
                } else {
                    recordButton.src = '../img/btn_collecting.gif';
                    isSpeaking = true;
                    tips.innerHTML = "你正在说话";
                    mediaRecorder.start();
                }
            });
        });

        // recordButton.addEventListener('touchstart', () => {
        //     gpt.src = '../img/speak.gif';
        //     audioChunks = [];
        //     mediaRecorder.start();
        // });

        // recordButton.addEventListener('touchend', () => {
        //     gpt.src = '../img/silent.gif';
        //     mediaRecorder.stop();
        // });

        function sendAudioToServer(audioBlob) {
            const reader = new FileReader();
            reader.onloadend = () => {
                const base64AudioMessage = reader.result.split(',')[1];
                assistant.src = '../img/thinking.gif';
                tips.innerHTML = "GPT思考中······";
                recordButton.style.display = "none";
                fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                        "actlike": "default",
                        "audio": base64AudioMessage,
                        "option": "6",
                        "voice": "onyx" //alloy, echo, fable, onyx 可以用的男生, nova, shimmer 可以用的女生
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        resultMessages = JSON.parse(decrypt(key, iv, data.message))
                        messages.push(...resultMessages)
                        console.log(messages)

                        // 将 Base64 编码的字符串转换为 bytes
                        var byteCharacters = atob(data.audio);
                        var byteNumbers = new Array(byteCharacters.length);
                        for (var i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        var byteArray = new Uint8Array(byteNumbers);

                        // 创建一个 Blob 对象
                        var blob = new Blob([byteArray], { type: 'audio/mpeg' });

                        // 创建一个 URL 并赋值给 audio 元素的 src 属性
                        var url = window.URL.createObjectURL(blob);
                        console.log(url)
                        var audio = document.createElement('audio');
                        audio.src = url;
                        document.body.appendChild(audio);

                        audio.addEventListener('play', function () {
                            assistant.src = '../img/speaking.gif';
                            tips.innerHTML = "GPT 正在讲话"
                        });

                        audio.addEventListener('pause', function () {
                            console.log('Audio is paused');
                        });

                        audio.addEventListener('ended', function () {
                            assistant.src = '../img/silent.gif';
                            tips.innerHTML = "点击讲话"
                            recordButton.style.display = "inline";
                        });

                        // 播放音频
                        audio.play();

                        // 使用 FileSaver.js 库来下载文件
                        // saveAs(blob, 'audio.mp3');
                    });
            };
            reader.readAsDataURL(audioBlob);
        }

        function changeImage() {


        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // 加密
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // 解密
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>