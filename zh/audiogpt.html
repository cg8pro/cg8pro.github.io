<!DOCTYPE html>
<html>

<head>
    <title>Talk GPT cg8.pro</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/audiogpt.css" rel="stylesheet" type="text/css" />
</head>

<body style="background-color: black;">
    <header>
        <div style="color:white;text-align: center;margin-top: 50px;font-size: 24px;">
            Talk GPT by <span style="color: rgb(26,173,26);"><a href="#" id="modal-trigger" style="color: rgb(26,173,26);">CG8</a>ğŸ‘ˆï¸</span>
        </div>
    </header>
    <div class="container main">
        <div style="text-align: center; margin-bottom: 20px;">
            <img id="assistant" class="assistant" src="../img/silent.gif" />
        </div>

    </div>
    <div class="footer">
        <div style="text-align: center; ">
            <img id="record" class="press" src="../img/btn_ready.gif" />
        </div>
        <span id="tips" style="color: white;font-size: 18px;display: none;"></span>
    </div>
    <!-- æ¨¡æ€æ¡† -->
    <div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <p>æ‰“é€ ä¸“å±ä¸šåŠ¡åœºæ™¯TalkGPT</p>
            <p>æˆªå›¾äºŒç»´ç ï¼Œå¾®ä¿¡æ‰«ä¸€æ‰«è”ç³»æˆ‘</p>
            <img style="width: 90%;" src="../img/wechat2.jpg" alt="cg8 äºŒç»´ç ">
            <p>æ›´å¤šï¼š</p>
            <p>GPTæ¥å…¥å®æˆ˜æ•™ç¨‹</p>
            <p>èº«ä»½å‡ºæµ·æ”»ç•¥</p>
        </div>
    </div>
    <script src="../js/forge.min.js"></script>
    <!--<script src="../js/vconsole.min.js"></script>-->
    <script src="../js/recorder.js"></script>
    <script>
        //var vConsole = new window.VConsole();
        let mediaRecorder;
        let audioChunks = [];
        let messages = [];
        let audioContext, source, recorder, stream;
        let isRecording = false; var monitorVar = false;
        var recordButton = document.getElementById('record');
        var assistant = document.getElementById('assistant');
        var gpt = document.getElementById("assistant");
        var tips = document.getElementById("tips")

        // ç‚¹å‡»å½•éŸ³æŒ‰é’®åçš„æ“ä½œ
        recordButton.addEventListener('click', function () {
            if (!isRecording) {
                recordButton.src = '../img/btn_collecting.gif';
                recordButton.style.width = '100px'
                gpt.src = "../img/speaking.gif"
                isRecording = true;

                // Step 1: ä»éº¦å…‹é£ä¸­è·å–éŸ³é¢‘æµ
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(function (mediaStream) {
                        stream = mediaStream;
                        audioContext = new AudioContext();
                        source = audioContext.createMediaStreamSource(stream);
                        recorder = new Recorder(source);

                        // å¼€å§‹å½•éŸ³
                        recorder.record();
                        isRecording = true;
                    })
                    .catch(function (err) {
                        console.log('è·å–éŸ³é¢‘æµå¤±è´¥ï¼š' + err);
                    });
            } else {
                recordButton.src = '../img/nospeak.gif';
                recordButton.style.width = '100px'
                recordButton.style.visibility = 'hidden'
                tips.style.display = "inline"
                tips.innerHTML = "ä½ çš„å£°éŸ³æ­£åœ¨èµ›åšå®‡å®™ä¸­å›è¡Â·Â·Â·"
                gpt.src = "../img/thinking.gif"

                // åœæ­¢å½•éŸ³
                recorder.stop();
                isRecording = false;

                // Step 2: å‘é€éŸ³é¢‘æ•°æ®åˆ°æœåŠ¡å™¨
                recorder.exportWAV(function (blob) {

                    // å°†blobè½¬ä¸ºbase64
                    let reader = new FileReader();
                    reader.onloadend = function () {
                        const base64AudioMessage = reader.result.split(',')[1];
                        console.log(base64AudioMessage);

                        fetch('https://1320865562-jq80o0roq9-sg.scf.tencentcs.com', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(messages))),
                                "actlike": "default",
                                "audio": base64AudioMessage,
                                "option": "6",
                                "voice": "onyx"
                            })
                        })
                            .then(response => response.json())
                            .then(data => {
                                var resultMessages = JSON.parse(decrypt(key, iv, data.message));
                                messages.push(...resultMessages);
                                console.log(messages);

                                // å°† Base64 ç¼–ç çš„å­—ç¬¦ä¸²è½¬æ¢ä¸º bytes
                                var byteCharacters = atob(data.audio);
                                var byteNumbers = new Array(byteCharacters.length);
                                for (let i = 0; i < byteCharacters.length; i++) {
                                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                                }
                                var byteArray = new Uint8Array(byteNumbers);

                                // Decode audio data with audio context
                                audioContext.decodeAudioData(byteArray.buffer, buffer => {

                                    let source = audioContext.createBufferSource();
                                    source.buffer = buffer;

                                    // è¿æ¥å›¾ï¼šéŸ³æº -> è¾“å‡ºï¼ˆæ‰¬å£°å™¨ï¼‰
                                    source.connect(audioContext.destination);

                                    source.onended = function () {
                                        assistant.src = '../img/silent.gif';
                                        recordButton.src = '../img/btn_ready.gif'
                                        recordButton.style.visibility = 'visible'
                                    };

                                    assistant.src = '../img/speaking.gif';
                                    tips.style.display = "none"
                                    // æ’­æ”¾éŸ³é¢‘
                                    source.start();
                                });
                            });
                    }

                    reader.readAsDataURL(blob);
                });
            }
        });

        // è·å–æ¨¡æ€æ¡†é“¾æ¥ï¼Œæ¨¡æ€æ¡†å…ƒç´ ï¼Œå’Œå…³é—­æŒ‰é’®å…ƒç´ 
        var modalTrigger = document.getElementById('modal-trigger');
        var modal = document.getElementById('myModal');
        var closeBtn = document.getElementsByClassName('close')[0];

        // ç‚¹å‡»é“¾æ¥æ—¶æ‰“å¼€æ¨¡æ€æ¡†
        modalTrigger.addEventListener('click', function (event) {
            event.preventDefault();
            modal.style.display = 'block';
        });

        // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–è€…æ¨¡æ€æ¡†å¤–éƒ¨æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†
        closeBtn.onclick = function () {
            modal.style.display = 'none';
        }
        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // åŠ å¯†
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // è§£å¯†
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>