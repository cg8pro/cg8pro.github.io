<!DOCTYPE html>
<html lang="en">

<head>
    <title>æ‹çˆ±åœ¨çº¿</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/header.css" rel="stylesheet" type="text/css" />
    <link href="../style/homerun.css" rel="stylesheet" type="text/css" />
    <link href="../img/favicon.png" rel="icon" type="image/png">
</head>

<body>   
    <header class="site-header" style="background-color: white;opacity: 0.7;">
        <div class="wrapper">
            <a class="site-title" style="font-size: 20px;" href="">
                æ‹çˆ±åœ¨çº¿
            </a>
            <nav class="site-nav">
                <div class="trigger">
                    <a style="color: white;font-weight:bold;text-shadow: 3px 3px 6px #000, -2px -2px 4px blueviolet;" class="page-link" href="./about.html">æ›´å¤š</a>
                </div>
            </nav>
        </div>
    </header>
    <div class="main" >
        <div class="row mainbox">
            <div class="progress-container">
                ğŸ’ª<div id="hpBar" class="hp-bar">0%</div>
            </div>
            <div class="progress-container">
                â¤ï¸<div id="feelBar" class="feel-bar">0%</div>
            </div>
            <div class="progress-container">
                ğŸ›¡ï¸<div id="defenseBar" class="defense-bar">0%</div>
            </div>
            <meter class="twelve columns" id="meter" style="margin-left: 0px; margin-top:5px;display: none;" min="0"
                    max="120" value="120"></meter>
            <div id="options" class="row">
                <div id="showSceneInfo" class="four columns option">
                    <span>>>åœºæ™¯æè¿°</span>
                </div>
                <div id="showSubGoals" class="four columns option">
                    <span >>>æ”»ç•¥æç¤º</span>
                </div>
                <div id="showFlurtImgs" class="four columns option">
                    <span >>>ç§æˆ¿æ¢èŠ±</span>
                </div>
            </div>
            <!-- <div style="width: 425px;height: 250px;position: fixed; top: 60px;"> -->
                <!-- <img src="../img/cyber_rain.gif" style="width: 413px;margin: 6px;border-radius: 10px;opacity: 0.5;" /> -->
            <!-- </div> -->
            <div id="chatbox" class="row"></div>
            <div class="row" style="display: flex; justify-content: center; align-items: center;">                
                <span id="status" style="font-size: 14px;float: left;color: RGB(200,200,200);color:red;">â¬¤</span>
                <input id="say" style="width: 75%;line-height: 30px; margin: 10px 10px 15px 10px;padding-left: 10px;" />
                <!-- <textarea id="say" style="display: inline;width: 80%;max-height: 45px;"></textarea> -->
                <img id="sendMessage" src="../img/send.png" style="width: 30px;margin: 5px 0 5px 0;"/>
                <button id="retrieveMessage"
                style="height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>åŠ è½½ä¼šè¯id</button>
            <button id="loadmessages"
                style="float:left;height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>åŠ è½½ä¸Šæ¬¡èŠå¤©</button>
            <button id="copyButton"
                style="float:left;height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>å¤åˆ¶ä¼šè¯id</button>
            </div>
            
            <div class="row">
                <span id="session" style="font-size: 14px;float: left;color: RGB(200,200,200);margin-right: 50px;display: none;"></span>
            </div>
            <!--</div>-->
        </div>
    </div>
    <div id="optionsModal" class="optionsModal" style="display: none;">
        <div class="options-modal-content">
            <div id="modalContent"></div>
            <span class="intro-close"
                style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;">æœ•çŸ¥é“äº†</span>
        </div>
    </div>
    <div id="menusModal" class="menusModal" style="display: none;">
        <div class="menus-modal-content">
            <div id="RBtnGroup0" class="row">
                <span id="newLove" style="margin: 0 10px; color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;">â™¥ </span>æ–°çš„çˆ±æ‹<span style="color: pink;"> â™¥</span></span>
                <span class="love-continue" style="margin: 0 10px; color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;">  </span>å†ç»­å‰ç¼˜<span style="color: pink;"> ğŸ’ƒ </span></span>
            </div>

            <!-- ç¬¬ä¸€ä¸ªoptionGroup -->
            <div id="RBtnGroup1st" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option11" name="optionGroup1" value="11">
                    <label for="option11">éšæœºåœºæ™¯æ¨¡å¼</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option12" name="optionGroup1" value="12" class="auto-uncheck" >
                    <label for="option12">è‡ªå®šä¹‰åœºæ™¯æ¨¡å¼</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option13" name="optionGroup1" value="13" class="auto-uncheck">
                    <label for="option13"><span style="color: red;">â™¥ </span>æ•…äº‹æ¨¡å¼<span style="color: red;"> â™¥</span></label>
                </div>
                <button id="Next1st" style="color:pink;">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- ç¬¬äºŒä¸ªoptionGroup -->
            <div id="RBtnGroup2nd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option21" name="optionGroup2" value="21">
                    <label for="option21">é‚»å®¶å°å¦¹</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option22" name="optionGroup2" value="22">
                    <label for="option22">é«˜å†·å¥³ç¥</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option23" name="optionGroup2" value="23">
                    <label for="option23">å‚²å¨‡å…¬ä¸»</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option24" name="optionGroup2" value="24" class="auto-uncheck">
                    <label for="option24">é­…é­”</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option25" name="optionGroup2" value="25" class="auto-uncheck">
                    <label for="option25">å¨¼é¬¼</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option26" name="optionGroup2" value="26" class="auto-uncheck">
                    <label for="option26">èŠ±ä¼</label>
                </div>
                <button id="Next2nd" style="color:pink;">ä¸‹ä¸€æ­¥</button>
            </div>

            <!-- ç¬¬ä¸‰ä¸ªoptionGroup -->
            <div id="RBtnGroup3rd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option31" name="optionGroup3" value="31" class="auto-uncheck">
                    <label for="option31">è½»æ¾äº¤è°ˆ</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option32" name="optionGroup3" value="32">
                    <label for="option32">æ™®é€šæ‹‰æ‰¯</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option33" name="optionGroup3" value="33" class="auto-uncheck">
                    <label for="option33">æ­è®ªè¾¾äºº</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option34" name="optionGroup3" value="34" class="auto-uncheck">
                    <label for="option34">é˜¿é¼»åœ°ç‹±</label>
                </div>
            </div>

            <div id="RBtnGroup3rd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option31" name="optionGroup3" value="31" class="auto-uncheck">
                    <label for="option31">è½»æ¾äº¤è°ˆ</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option32" name="optionGroup3" value="32">
                    <label for="option32">æ™®é€šæ‹‰æ‰¯</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option33" name="optionGroup3" value="33" class="auto-uncheck">
                    <label for="option33">æ­è®ªè¾¾äºº</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option34" name="optionGroup3" value="34" class="auto-uncheck">
                    <label for="option34">é˜¿é¼»åœ°ç‹±</label>
                </div>
            </div>

            <div class="row">
                <label id="loveLoading"></label>
            </div>
            <div class="row">
                <span id="modeInfo"></span>
            </div>
            <div class="row">
                <span id="actorInfo"></span>
            </div>
            <div class="row">
                <span id="difficultyInfo"></span>
            </div>
            <div class="row">
                <span id="menuWarning" style="color: red;"></span>
            </div>

            <div id="RBtnGroup4th" class="row" style="display: none;">
                <br/>
                <lable id="fakeLoading" style="color: white;" >å¯åŠ¨ä¸­...</lable>
            </div>

            <div class="row love-go-div" style="margin-top: 50px;display: none;">
                <span class="love-go" style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;"> â™¥ â™¥ â™¥ </span>æ‹çˆ±å¯åŠ¨<span style="color: pink;"> â™¥ â™¥ â™¥ </span></span>
            </div>
            <div class="scrolling-wrapper" style="height: 100%; position: absolute;top:0;left:0;z-index: -999;">
                <img src="../img/danger.jpg" class="scrolling-image scroll" alt="Scrolling Image" >
            </div>
            <div class="row" style="position: fixed; bottom: 10px;width: 80%;margin: auto;">
                <span>@Copyright www.cg8.pro</span><br/>
                <span>Powered by OpenAI GPTs</span>
            </div>
        </div>
    </div>
    <div id="gameReportModal" class="gameReportModal" style="display: none;">
        <div class="game-report-modal-content">
            <div id="opinionsReport">
            </div>
            <span class="intro-close" onclick="location.reload()"
                style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;cursor:pointer;">é‡ç”Ÿ</span>
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/forge.min.js"></script>
    <script src="../js/vconsole.min.js"></script>
    <script>
        var vConsole = new window.VConsole();

        var remote = 'https://cpltsbiz.azurewebsites.net/api/cplts/';
        var countdown;
        var seconds = 120;

        var playMode = "";
        var playActor = "";
        var playDifficulty = "";

        var scene = '';
        var feel = 0;
        var defense = 0;
        var goal = '';
        var leftTry = 0;
        var maxTry = 0;
        var ladyFirst = '';
        var girlTalk = '';
        var isSuccess = '';
        var opinions = [];

        var messages = [];

        const fakeBehavior = [
            "æ„å»ºæ‹çˆ±äº¤äº’åœºæ™¯...",
            "æ¸…ç†ç³»ç»Ÿç¼“å­˜...",
            "è£…è½½æ€§æ ¼ç‰¹å¾...",
            "æ„å»ºå¿ƒé‡Œé˜²å¾¡...",
            "åˆå§‹åŒ–ä¸–ç•Œè§‚...",
            "ç»˜åˆ¶ç§å¯†åœºæ™¯...",
            "è£…è½½äººå·¥æ™ºèƒ½å¹²æ¶‰å™¨...",
            "å¸è½½é­…é­”å¤±æ§ç¦åˆ¶...",
            "åˆå§‹åŒ–é˜¿é»‘é¢œå‘ç”Ÿå™¨...",
            "åŠ è½½æ­¥å…µé«˜æ¸…å±€éƒ¨ç”»è´¨...",
            "å¯åŠ¨æ€§æ ¼å´©è£‚åŠ é€Ÿå™¨...",
            "åŠ è½½é›„æ€§ç½è£…ææ–™...",
            "å±è”½å¨¼é¬¼å´©æºƒæ€§æ ¼æ¨¡å‹...",
            "å‘æ‹çˆ±å¼•æ“æŠ•å°„æ³¡å­¦æ˜ å°„...",
            "å‘æ‹çˆ±å¼•æ“æŠ•å°„æå¥³å¿ƒç†å­¦æ˜ å°„..."
        ];

        var textarea = document.getElementById("say");
        var enterGuide = document.getElementById("enterGuide")
        var sendMessage = document.getElementById("sendMessage")
        var retrieveMessage = document.getElementById("retrieveMessage")
        var currentsession = document.getElementById("session");
        var session = getCookie("CHATGPTOLID");
        var loadmessages = document.getElementById("loadmessages")
        var modalContent = document.getElementById("modalContent")
        //var testBtn = document.getElementById("testButton")
        var optionsModal = document.getElementById('optionsModal');
        var menusModal = document.getElementById('menusModal')
        var gameReportModal = document.getElementById('gameReportModal');
        var introCloseBtn = document.getElementsByClassName('intro-close')[0];
        var loveGoBtn = document.getElementsByClassName('love-go')[0];
        var loveGoDiv = document.getElementsByClassName('love-go-div')[0]
        var loveContinueBtn = document.getElementsByClassName('love-continue')[0];
        var showSceneInfo = document.getElementById('showSceneInfo');
        var chatbox = document.getElementById("chatbox");
        var newLove = document.getElementById("newLove");
        var rBtnGroup0 = document.getElementById("RBtnGroup0");
        var rBtnGroup1st = document.getElementById("RBtnGroup1st");
        var rBtnGroup2nd = document.getElementById("RBtnGroup2nd");
        var rBtnGroup3rd = document.getElementById("RBtnGroup3rd");
        var rBtnGroup4th = document.getElementById("RBtnGroup4th");
        var next1st = document.getElementById("Next1st");
        var next2nd = document.getElementById("Next2nd");
        var fakeLoading = document.getElementById("fakeLoading");
        var opinionsReport = document.getElementById("opinionsReport");

        const rdm1 = Math.floor(Math.random() * 12) + 1;
        var boyAvatarPath = '../img/avatar/boy' + rdm1 + '.jpg';
        const rdm2 = Math.floor(Math.random() * 12) + 1;
        var girlAvatarPath = '../img/avatar/girl' + rdm2 + '.jpg';

        window.onload = function () {
            echo();
            setInterval(() => {
                echo();
            }, 10000);

            chatbox.innerHTML = "";
            menusModal.style.display = 'block';
            
            showSceneInfo.addEventListener('click', (event) => {
                modalContent.innerHTML = "<strong>æ”»ç•¥åœºæ™¯ï¼š</strong>" +  scene + "<strong>ç›®æ ‡ï¼š</strong>" + goal;
                optionsModal.style.display = 'block';
            })

            showSubGoals.addEventListener('click', (event) => {
                modalContent.innerHTML = "æœªæˆæƒç‰ˆæœ¬";
                optionsModal.style.display = 'block';
            })

            showFlurtImgs.addEventListener('click', (event) => {
                modalContent.innerHTML = "æœªæˆæƒç‰ˆæœ¬";
                optionsModal.style.display = 'block';
            })

            newLove.addEventListener('click', (event) => {
                rBtnGroup0.style.display = "none";
                rBtnGroup1st.style.display = "block";
            })

            next1st.addEventListener('click', (event) => {
                if(playMode == ""){
                    alert("è¯·æ­£ç¡®é€‰æ‹©æ¨¡å¼")
                } else{
                    rBtnGroup1st.style.display = "none";
                    rBtnGroup2nd.style.display = "block";
                }
            })

            next2nd.addEventListener('click', (event) => {
                if(playActor == ""){
                    alert("è¯·æ­£ç¡®é€‰æ‹©æ€§æ ¼")
                } else{
                    rBtnGroup2nd.style.display = "none";
                    rBtnGroup3rd.style.display = "block";
                    loveGoDiv.style.display = "block";
                }
            })

            loveGoBtn.onclick = async function() {
                if(playDifficulty == ""){
                    alert("è¯·æ­£ç¡®é€‰æ‹©éš¾åº¦")
                }
                else{
                    rBtnGroup3rd.style.display = "none";
                    loveGoDiv.style.display = "none";
                    rBtnGroup4th.style.display = "block"
                    var message = { "role": "user", "content": playMode + "," + playActor + "," + playDifficulty }
                    const intervalId = setInterval(updateFakeLoading, 2500);
                    const initResult = await sendMessages(message);
                    if (initResult){
                        clearInterval(intervalId);
                        rBtnGroup4th.style.display = "none"
                        menusModal.style.display = 'none';
                        optionsModal.style.display = 'block';
                    }
                }
            }

            function updateFakeLoading() {
                const randomIndex = Math.floor(Math.random() * fakeBehavior.length);
                fakeLoading.innerHTML = `æ­£åœ¨${fakeBehavior[randomIndex]}`;
            }

            window.onclick = function (event) {
                if (event.target == optionsModal) {
                    optionsModal.style.display = 'none';
                }
            }

            // ç‚¹å‡»å…³é—­æŒ‰é’®æˆ–è€…æ¨¡æ€æ¡†å¤–éƒ¨æ—¶ï¼Œå…³é—­æ¨¡æ€æ¡†
            introCloseBtn.onclick = function () {
                optionsModal.style.display = 'none';
                gameReportModal.style.display = 'none';
            }

            // loveGoBtn.onclick = function () {
            //     console.log(getSelectedOptions())
            // }


            loveContinueBtn.onclick = function() {
                var menuWarning = document.getElementById('menuWarning');
                menuWarning.innerHTML = '<strong style="color:red">æ‹çˆ±æ—¶ç©ºå›å»Šè¿˜æœªå¯¹ä½ å¼€æ”¾</strong>';
            }

            var radios1 = document.getElementsByName('optionGroup1');
            var radios2 = document.getElementsByName('optionGroup2');
            var radios3 = document.getElementsByName('optionGroup3');
            Array.prototype.forEach.call(radios1, function(radio) {
                radio.addEventListener('change', radioChanged);
            });
            Array.prototype.forEach.call(radios2, function(radio) {
                radio.addEventListener('change', radioChanged);
            });
            Array.prototype.forEach.call(radios3, function(radio) {
                radio.addEventListener('change', radioChanged);
            });

            // message1 = { "role": "user", "content": "111" }
            // message2 = { "role": "assistant", "content": "111" }
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // fillChatbox(messages);

            const isMobile = getDeviceType() == "mobile";
            //enterGuide.style.display = isMobile ? "none" : "inline";
            //sendMessage.style.display = isMobile ? "inline" : "none";
            //retrieveMessage.style.display = isMobile ? "inline" : "none";
        }

        loadmessages.addEventListener('click', (event) => {
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "1",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                    "session": session
                })
            })
            .then(response => response.json())
            .then(data => {
                //countdownLable.style.display = "none"
                // meter.style.display = "none"
                //countdownLable.innerHTML = seconds;
                seconds = 120;
                stopCountdown();
                if (data.cptCnt == 0) {
                    messages.pop();
                } else {
                    messages.length = 0;
                    currentsession.innerHTML = session
                    JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                        messages.push(item);
                    })
                    // console.log(messages)
                    fillChatbox(messages)
                    setTimeout(function () {
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }, 0);
                }
            })
            .catch(error => {
                console.error(error);
            });
        })

        sendMessage.addEventListener('click', sendMessageHandler);
        
        function sendMessageHandler(){
            //var countdownLable = document.getElementById("countdownLable")
            var meter = document.getElementById("meter")
            //countdownLable.style.display = "block"
            // meter.style.display = "block"
            //countdownLable.innerHTML = seconds;
            startCountdown();

            event.preventDefault();
            message = { "role": "user", "content": textarea.value }
            messages.push(message)
            textarea.value = ""
            fillChatbox(messages);
            setTimeout(function () {
                chatbox.scrollTop = chatbox.scrollHeight;
            }, 0);
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "7",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(message))),
                    "session": currentsession.innerHTML
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // console.log(data)
                    if (data.cptCnt == 0) {
                        messages.pop();
                    } else {
                        currentsession.innerHTML = data.session
                        if (!getCookie("CHATGPTOLID")) {
                            document.cookie = "CHATGPTOLID=" + data.session + "; path=/";
                        }

                        messages = messages.concat(JSON.parse(decrypt(key, iv, data.message)))
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        }

        retrieveMessage.addEventListener('click', () => {
            //var countdownLable = document.getElementById("countdownLable")
            var meter = document.getElementById("meter")
            //countdownLable.style.display = "block"
            // meter.style.display = "block"
            //countdownLable.innerHTML = seconds;
            startCountdown();

            event.preventDefault();
            fillChatbox(messages);
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "1",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                    "session": textarea.value
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // console.log(data)
                    if (data.cptCnt == 0) {
                        messages.pop();
                    } else {
                        messages.length = 0;
                        currentsession.innerHTML = textarea.value
                        document.cookie = "CHATGPTOLID=" + textarea.value + "; path=/";
                        JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                            messages.push(item);
                        })
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        })

        // testBtn.addEventListener('click', () => {
        //     fetch(remote , {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'                        
        //         },
        //         body: JSON.stringify({
        //             "option": "41",
        //             "imgdesc":"something very cool",
        //             "session": "dalle3 test"
        //         })
        //     })
        //         .then(response => console.log(response))
        //         .catch(error => {
        //             console.error(error);
        //         });
        // })

        textarea.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.ctrlKey) {
                //var countdownLable = document.getElementById("countdownLable")
                var meter = document.getElementById("meter")
                //countdownLable.style.display = "block"
                // meter.style.display = "block"
                //countdownLable.innerHTML = seconds;
                startCountdown();
                event.preventDefault(); 

                var message = { "role": "user", "content": textarea.value }
                sendMessages(message);                    
            }
            if (event.key === 'Enter' && event.altKey) {
                //var countdownLable = document.getElementById("countdownLable")
                var meter = document.getElementById("meter")
                //countdownLable.style.display = "block"
                // meter.style.display = "block"
                //countdownLable.innerHTML = seconds;
                startCountdown();

                event.preventDefault();
                fillChatbox(messages);
                fetch(remote , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        
                    },
                    body: JSON.stringify({
                        "option": "1",
                        "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                        "session": textarea.value
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        //countdownLable.style.display = "none"
                        // meter.style.display = "none"
                        //countdownLable.innerHTML = seconds;
                        seconds = 120;
                        stopCountdown();

                        // console.log(data)
                        if (data.cptCnt == 0) {
                            messages.pop();
                        } else {
                            messages.length = 0;
                            currentsession.innerHTML = textarea.value
                            document.cookie = "CHATGPTOLID=" + textarea.value + "; path=/";
                            JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                                messages.push(item);
                            })
                            fillChatbox(messages)
                            textarea.value = ''
                            setTimeout(function () {
                                chatbox.scrollTop = chatbox.scrollHeight;
                            }, 0);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        });
        document.querySelector("#copyButton").addEventListener('click', function () {
            copySpanTextToClipboard('session');
        });

        async function sendMessages(message) {
            messages.push(message)
            textarea.value = "";
            if(messages.length == 1){
                messages.splice(0,1);
            }
            fillChatbox(messages);
            setTimeout(function () {
                chatbox.scrollTop = chatbox.scrollHeight;
            }, 0);
            await fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "7",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(message))),
                    "session": currentsession.innerHTML,
                    "asst": "asst_EB53dezUxmfLtC3nXv9y7IXK"
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // if (data.cptCnt == 0) {
                    //     messages.pop();
                    // } else {
                        currentsession.innerHTML = data.session
                        if (!getCookie("CHATGPTOLID")) {
                            document.cookie = "CHATGPTOLID=" + data.session + "; path=/";
                        }
                        console.log(data.message)
                        messages = messages.concat(JSON.parse(decrypt(key, iv, data.message)))
                        // console.log(messages)
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    // }
                })
                .catch(error => {
                    console.error(error);
                });
                return true;
        }

        function fillChatbox(messages) {
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = "";
            messages.forEach(msg => {
                const msgLine = document.createElement('div');
                msgLine.classList.add('msgLine');
                const msgtext = document.createElement('div');
                msgtext.style = "text-align:left;"
                const contentBlocks = parseContent(msg.content, msg.role);
                contentBlocks.forEach(block => {
                    if (block.type === 'img'){
                        // æ¸²æŸ“å›¾ç‰‡
                        const img = document.createElement('img');
                        img.src = block.content;
                        img.style = "width:360px;height:360px;display:block;border: 3px solid gray;border-radius: 15px;margin-bottom:15px;";
                        msgtext.appendChild(img);
                    } else if (block.type === 'gpt_op_prompt' || block.type === 'dalle_op_prompt'){
                        // ä¼˜åŒ–åçš„æç¤ºè¯æ–‡æœ¬å—
                        const span = document.createElement('span');
                        span.style = "display:block;"
                        span.innerHTML = block.content;
                        msgtext.appendChild(span);
                    } else if (block.type === 'code') {
                        // æ¸²æŸ“ä»£ç å— 
                        // const pre = document.createElement('pre');
                        // const code = document.createElement('code');
                        // pre.style.color = 'black';
                        // code.textContent = block.content;
                        // pre.appendChild(code);

                        var jsonObj = JSON.parse(block.content);
                        // console.log(jsonObj)
                        const text = document.createElement('text');
                        if(scene == ''){
                            leftTry = +jsonObj.maxTry;
                            maxTry = +jsonObj.maxTry;
                            scene = jsonObj.scene;
                            goal = jsonObj.goal;
                            ladyFirst = jsonObj.ladyFirst;
                            text.textContent = ladyFirst;
                            modalContent.innerHTML = "<strong>æ”»ç•¥åœºæ™¯ï¼š</strong>" +  scene + "<strong>ç›®æ ‡ï¼š</strong>" + goal;
                            if(ladyFirst == "" || ladyFirst == undefined){
                                ladyFirst = "..."
                            }
                            msgtext.appendChild(text)
                        } else {
                            leftTry = +jsonObj.leftTry;
                            if(jsonObj.girlTalk == undefined){
                                girlTalk = ladyFirst;
                            } else if (jsonObj.girlTalk != "" || jsonObj.girlTalk != undefined) {
                                girlTalk = jsonObj.girlTalk;
                            } else {
                                girlTalk = "..."
                            }
                            text.textContent = girlTalk;
                            msgtext.appendChild(text)
                        }
                        updateBar(parseInt(leftTry),parseInt(maxTry),"hpBar")
                        feel = +jsonObj.feel;
                        updateBar(parseInt(feel),100,"feelBar")
                        defense = +jsonObj.defense;
                        updateBar(parseInt(defense),100,"defenseBar")

                        // æ¸¸æˆç»“æŸé€»è¾‘
                        if(jsonObj.isSuccess != undefined){
                            isSuccess = jsonObj.isSuccess;
                            opinions = jsonObj.opinions;
                            textarea.disabled = true;
                            sendMessage.removeEventListener('click', sendMessageHandler)

                            opinions.forEach(opinion => {
                                const opinionDiv = document.createElement('div');
                                opinionDiv.classList.add('row');
                                const boyLine = document.createElement('span');
                                boyLine.classList.add('row')
                                boyLine.style.color = 'white';
                                boyLine.innerHTML = opinion.words;
                                const advice = document.createElement('span');
                                advice.classList.add('row');
                                advice.style.color = 'yellow';
                                advice.innerHTML = opinion.opinion;
                                const can = document.createElement('span');
                                can.classList.add('row');
                                can.style.color = 'lightblue';
                                can.innerHTML = opinion.can;

                                opinionDiv.appendChild(boyLine);
                                opinionDiv.appendChild(advice);
                                opinionDiv.appendChild(can);
                                opinionsReport.appendChild(opinionDiv);
                            })

                            gameReportModal.style.display = 'block';
                        }
                    } else {
                        const span = document.createElement('span');
                        span.innerHTML = block.content;
                        msgtext.appendChild(span);
                    }
                });

                const img = document.createElement('img');

                if (msg.role === 'user') {
                    img.src = boyAvatarPath;
                    img.style = "width:40px;margin:5px 5px;float:right;border-radius:5px;";
                    msgLine.appendChild(img);
                    msgLine.appendChild(msgtext)
                    msgtext.classList.add('user-msg');
                } else if (msg.role === 'assistant') {
                    img.src = girlAvatarPath;
                    img.style = "width:40px;margin:5px 5px;float:left;border-radius:5px;";
                    msgLine.appendChild(img);
                    msgLine.appendChild(msgtext)
                    msgtext.classList.add('assistant-msg');
                }
                
                chatbox.appendChild(msgLine)
            });
        }

        function parseContent(content,role) {
            let blocks = [];
            let lines = content.split('\n');
            let inCode = false;
            let text = '';
            let code = '';
            if(role === "user"){
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    if (line.startsWith('[image]')) {
                        // DALLE3 å›¾ç‰‡

                        // åŒ¹é…Image URL
                        let imageRegex = /\[image\](.*?)\[gpt_prompt\]/;
                        let imageUrl = line.match(imageRegex)[1];

                        // åŒ¹é…DALLÂ·E Prompt
                        // let gptPromptRegex = /\[gpt_prompt\](.*)/;
                        // let gptPrompt = line.match(gptPromptRegex)[1];

                        // // åŒ¹é…GPT Prompt
                        let gptPromptRegex = /\[gpt_prompt\](.*?)\[dalle_prompt\]/;
                        let gptPrompt = line.match(gptPromptRegex)[1];

                        // // åŒ¹é…DALLÂ·E Prompt
                        let dallePromptRegex = /\[dalle_prompt\](.*)/;
                        let dallePrompt = line.match(dallePromptRegex)[1];

                        blocks.push({ type: 'img', content: imageUrl})
                        blocks.push({ type: 'gpt_op_prompt', content: 'ChatGPT æ”¹å†™çš„æç¤ºè¯ï¼š' + gptPrompt})
                        blocks.push({ type: 'dalle_op_prompt', content: 'DALLE ä¼˜åŒ–çš„æç¤ºè¯ï¼š' + dallePrompt})

                    } else if (line.startsWith('```') && !inCode) {
                        // æ–‡æœ¬å—ç»“æŸæˆ–ä»£ç å—å¼€å§‹
                        if (text) {
                            blocks.push({ type: 'text', content: text });
                            text = '';
                        }
                        inCode = !inCode;
                    } else if (line.endsWith('```') && inCode) {
                        // ä»£ç å—ç»“æŸ
                        inCode = false;
                        blocks.push({ type: 'code', content: code });
                        code = '';
                    } else {
                        if (inCode) {
                            // ç§¯ç´¯ä»£ç å†…å®¹
                            code += line + '\n';
                        } else {
                            // ç§¯ç´¯æ–‡æœ¬å†…å®¹  
                            text += line + '\n';
                        }
                    }
                }
            } else {
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    if (line.startsWith('[image]')) {
                        // DALLE3 å›¾ç‰‡

                        // åŒ¹é…Image URL
                        let imageRegex = /\[image\](.*?)\[gpt_prompt\]/;
                        let imageUrl = line.match(imageRegex)[1];

                        // åŒ¹é…DALLÂ·E Prompt
                        // let gptPromptRegex = /\[gpt_prompt\](.*)/;
                        // let gptPrompt = line.match(gptPromptRegex)[1];

                        // // åŒ¹é…GPT Prompt
                        let gptPromptRegex = /\[gpt_prompt\](.*?)\[dalle_prompt\]/;
                        let gptPrompt = line.match(gptPromptRegex)[1];

                        // // åŒ¹é…DALLÂ·E Prompt
                        let dallePromptRegex = /\[dalle_prompt\](.*)/;
                        let dallePrompt = line.match(dallePromptRegex)[1];

                        blocks.push({ type: 'img', content: imageUrl})
                        blocks.push({ type: 'gpt_op_prompt', content: 'ChatGPT æ”¹å†™çš„æç¤ºè¯ï¼š' + gptPrompt})
                        blocks.push({ type: 'dalle_op_prompt', content: 'DALLE ä¼˜åŒ–çš„æç¤ºè¯ï¼š' + dallePrompt})

                    } else if (line.startsWith('```') && !inCode) {
                        // æ–‡æœ¬å—ç»“æŸæˆ–ä»£ç å—å¼€å§‹
                        if (text) {
                            blocks.push({ type: 'text', content: text });
                            text = '';
                        }
                        inCode = !inCode;
                    } else if (line.endsWith('```') && inCode) {
                        // ä»£ç å—ç»“æŸ
                        inCode = false;
                        blocks.push({ type: 'code', content: code });
                        code = '';
                    } else {
                        if (inCode) {
                            // ç§¯ç´¯ä»£ç å†…å®¹
                            code += line + '\n';
                        } else {
                            // ç§¯ç´¯æ–‡æœ¬å†…å®¹  
                            // text += line + '\n';
                        }
                    }
                }
            }
            
            // æ”¶å°¾ 
            if (text)
                blocks.push({ type: 'text', content: text });
            return blocks;
        }

        function showGameResult(){
            gameReportModal.style.display = 'block';
            if(isSuccess == "true"){
                opinions.innerHTML = '<span style="color:lightgreen">æ”»ç•¥æˆåŠŸï¼</span>'
            } else {
                opinions.innerHTML = '<span style="color:red">æ”»ç•¥å¤±è´¥ï¼</span>'
            }
        }

        function copySpanTextToClipboard(spanId) {
            var span = document.getElementById(spanId);
            var text = span.textContent;
            var tempTextarea = document.createElement('textarea');
            tempTextarea.style = "position: absolute; left: -1000px; top: -1000px";
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            if (text.length > 0) {
                alert("ä¼šè¯idå·²å¤åˆ¶åˆ°å‰ªè´´æ¿")
            }
        }
        
        function startCountdown() {
            countdown = setInterval(function () {
                seconds--;
                $('#meter')[0].value = seconds;
                //$("#countdownLable").html(seconds);
                if (seconds <= 0) {
                    clearInterval(countdown);
                }
            }, 1000);
        }

        function stopCountdown() {
            clearInterval(countdown);
            $('#countdown').text('å€’è®¡æ—¶ç»“æŸ');
        }

        function getCookie(name) {
            var cookies = document.cookie.split("; ");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].split("=");
                if (cookie[0] === name) {
                    return cookie[1];
                }
            }
            return false;
        }

        function getDeviceType() {
            const userAgent = navigator.userAgent;
            if (/Mobile|iPod/i.test(userAgent)
                || /Android/i.test(userAgent) && !/Mobile/i.test(userAgent)) {
                return "mobile";
            } else {
                return "desktop";
            }
        }

        function updateBar(currentValue, maxValue, barId) {
            var progressBar = document.getElementById(barId);
            var width = (currentValue / maxValue) * 370;
            progressBar.style.width = width + 'px'; // è®¾ç½®å®½åº¦
            progressBar.textContent = currentValue; // æ˜¾ç¤ºæ–‡å­—
        }

        function getSelectedOptions() {
            var selectedOptions = {};
            var groups = ['optionGroup1', 'optionGroup2', 'optionGroup3'];
            groups.forEach(function(group) {
                var selectedRadio = document.querySelector(`input[name="${group}"]:checked`);
                selectedOptions[group] = selectedRadio ? selectedRadio.value : null;
            });
            return selectedOptions;
        }

        function radioChanged(event) {
            var radioId = event.target.id;
            var modeInfo = document.getElementById('modeInfo');
            var actorInfo = document.getElementById('actorInfo');
            var difficultyInfo = document.getElementById('difficultyInfo');
            var menuWarning = document.getElementById('menuWarning');

            // å¦‚æœè¯¥å•é€‰æŒ‰é’®åº”è¯¥å–æ¶ˆé€‰ä¸­
            if (event.target.classList.contains('auto-uncheck')) {
                setTimeout(function() { // ä½¿ç”¨ setTimeout æ¥å»¶è¿Ÿå–æ¶ˆé€‰ä¸­
                    event.target.checked = false;
                }, 0);
                // if(event.target.value.startsWith('1')){
                //     menuWarning.innerHTML = "æœªæˆæƒæ¨¡å¼ä¸æ”¯æŒè¯¥æ¨¡å¼";
                // }
                // if(event.target.value.startsWith('2')){
                //     menuWarning.innerHTML = "æœªæˆæƒæ¨¡å¼ä¸æ”¯æŒè¯¥æ€§æ ¼è®¾å®š";
                // }
                // if(event.target.value.startsWith('3')){
                //     menuWarning.innerHTML = "æœªæˆæƒæ¨¡å¼ä¸æ”¯æŒéš¾åº¦é€‰æ‹©";
                // }
                
            }
            menuWarning.innerHTML = "";
            // æ ¹æ®é€‰ä¸­çš„å•é€‰æŒ‰é’®ï¼Œæ˜¾ç¤ºç›¸åº”çš„ä¿¡æ¯
            switch(event.target.value) {
                case '11':
                    modeInfo.innerHTML = '<strong style="color:gold">éšæœºåœºæ™¯æ¨¡å¼</strong>ï¼šå…¨å’è®­ç»ƒå¤§å¸ˆéšæœºç”Ÿæˆæ­è®ªåœºæ™¯';
                    playMode = "éšæœºåœºæ™¯æ¨¡å¼";
                    break;
                case '12':
                    modeInfo.innerHTML = '<strong style="color:gold">è‡ªå®šä¹‰åœºæ™¯æ¨¡å¼</strong>ï¼šå°½å¯èƒ½è¯¦ç»†çš„è¾“å…¥ä½ ç°å®è¿½æ±‚å¯¹è±¡çš„ç»†èŠ‚ï¼Œå…¨å’è®­ç»ƒå¤§å¸ˆä¼šæ¨¡æ‹Ÿå…¶è¡Œä¸ºï¼Œä¸ä½ å±•å¼€æ¨¡æ‹Ÿå®æˆ˜è®­ç»ƒã€‚<strong style="color:red">å½“å‰æœªæˆæƒï¼Œä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playMode = "è‡ªå®šä¹‰åœºæ™¯æ¨¡å¼";
                    playMode = ""
                    break;
                case '13':
                    modeInfo.innerHTML = '<strong style="color:gold">æ•…äº‹æ¨¡å¼</strong>ï¼šå¼€å±•ä¸€åœºçœŸå®çš„æ‹ŸçœŸè¿½æ±‚ä½“éªŒï¼Œå°½å¯èƒ½è¯¦ç»†çš„è¾“å…¥ä½ ç°å®è¿½æ±‚å¯¹è±¡çš„ç»†èŠ‚ï¼Œå…¨å’è®­ç»ƒå¤§å¸ˆä¼šæ¨¡æ‹Ÿå…¶è¡Œä¸ºï¼Œä¸ä½ å±•å¼€æ¨¡æ‹Ÿå®æˆ˜è®­ç»ƒã€‚<strong style="color:red">å½“å‰æœªæˆæƒï¼Œä¸æ”¯æŒé€‰æ‹©è¯¥æ¨¡å¼</strong>';
                    //playMode = "æ•…äº‹æ¨¡å¼";
                    playMode = ""
                    break;
                case '21':
                    actorInfo.innerHTML = '<strong style="color:gold">é‚»å®¶å°å¦¹æ€§æ ¼ï¼š</strong>â€œä»Šå¤©ä¹Ÿå»å›¾ä¹¦é¦†ä¸€èµ·å­¦ä¹ å—ï¼Ÿâ€';
                    playActor = "é‚»å®¶å°å¦¹";
                    break;
                case '22':
                    actorInfo.innerHTML = '<strong style="color:gold">é«˜å†·å¥³ç¥æ€§æ ¼ï¼š</strong>â€œä½ ç®—æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿâ€';
                    playActor = "é«˜å†·å¥³ç¥";
                    break;
                case '23':
                    actorInfo.innerHTML = '<strong style="color:gold">å‚²å¨‡å…¬ä¸»æ€§æ ¼ï¼š</strong>â€œè¿½æ±‚æˆ‘çš„äººï¼Œå¯æ˜¯æ’ç€é˜Ÿå‘¢ï¼â€';
                    playActor = "å‚²å¨‡å…¬ä¸»";
                    break;
                case '24':
                    actorInfo.innerHTML = '<strong style="color:gold">é­…é­”æ€§æ ¼ï¼š</strong>â€œå®è´ï¼Œè·ªä¸‹~â€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playActor = "é­…é­”";
                    playActor = ""
                    break;
                case '25':
                    actorInfo.innerHTML = '<strong style="color:gold">å¨¼é¬¼æ€§æ ¼ï¼š</strong>â€œè‡­ä¸œè¥¿ï¼Œè¿™æ ·å°±ä¸è¡Œäº†ï¼Ÿâ€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playActor = "å¨¼é¬¼";
                    playActor = ""
                    break;
                case '26':
                    actorInfo.innerHTML = '<strong style="color:gold">èŠ±ä¼æ€§æ ¼ï¼š</strong>â€œè¦æ¬£èµå¦¾èº«çš„èˆå§¿å—ï¼Ÿâ€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playActor = "èŠ±ä¼";
                    playActor = ""
                    break;
                case '31':
                    difficultyInfo.innerHTML = '<strong style="color:gold">è½»æ¾äº¤è°ˆï¼š</strong>â€œå¯¹æœ¬æ®¿è€Œè¨€æ¯«æ— éš¾åº¦â€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playDifficulty = "è½»æ¾";
                    playDifficulty = ""
                    break;
                case '32':
                    difficultyInfo.innerHTML = '<strong style="color:gold">æ™®é€šæ‹‰æ‰¯ï¼š</strong>â€œè¿™å°å¦®æ¨æ‹‰åŠŸå¤«äº†å¾—ï¼Œä¸å¤ªå¥½æâ€';
                    playDifficulty = "æ™®é€š";
                    break;
                case '33':
                    difficultyInfo.innerHTML = '<strong style="color:gold">æ­è®ªè¾¾äººï¼š</strong>â€œæœ¬ç‹çœ¼ä¸­æ²¡æœ‰éš¾æçš„å¯¹è±¡â€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playDifficulty = "è¾¾äºº";
                    playDifficulty = ""
                    break;         
                case '34':
                    difficultyInfo.innerHTML = '<strong style="color:gold">é˜¿é¼»åœ°ç‹±ï¼š</strong>â€œæ±Ÿæ¹–è·¯è¿œï¼ŒåŠå¤§ä¾ é‡æ–°æ¥è¿‡â€.<strong style="color:red">å½“å‰ä¸æ”¯æŒé€‰æ‹©</strong>';
                    //playDifficulty = "åœ°ç‹±";
                    playDifficulty = ""
                    break;           
            }
        }

        function echo() {
            const currentsession = document.getElementById("status");
            fetch(remote , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "option": "0",
                    })
                })
                .then(response => {
                    if (!response.ok || response.status < 200 || response.status > 299){
                        currentsession.innerHTML = "â¬¤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:red;"
                    }
                    return response;
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status == "ok") {
                        currentsession.innerHTML = "â¬¤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:green;"
                    } else {
                        currentsession.innerHTML = "â¬¤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:red;"
                    }
                })
                .catch(error => {
                    console.error(error);
                }
            );
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // åŠ å¯†
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // è§£å¯†
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>