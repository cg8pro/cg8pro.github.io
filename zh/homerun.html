<!DOCTYPE html>
<html lang="en">

<head>
    <title>恋爱在线</title>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="../style/normalize.css" rel="stylesheet" type="text/css" />
    <link href="../style/skeleton.css" rel="stylesheet" type="text/css" />
    <link href="../style/header.css" rel="stylesheet" type="text/css" />
    <link href="../style/homerun.css" rel="stylesheet" type="text/css" />
    <link href="../img/favicon.png" rel="icon" type="image/png">
</head>

<body>   
    <header class="site-header" style="background-color: white;opacity: 0.7;">
        <div class="wrapper">
            <a class="site-title" style="font-size: 20px;" href="">
                恋爱在线
            </a>
            <nav class="site-nav">
                <div class="trigger">
                    <a style="color: white;font-weight:bold;text-shadow: 3px 3px 6px #000, -2px -2px 4px blueviolet;" class="page-link" href="./about.html">更多</a>
                </div>
            </nav>
        </div>
    </header>
    <div class="main" >
        <div class="row mainbox">
            <div class="progress-container">
                💪<div id="hpBar" class="hp-bar">0%</div>
            </div>
            <div class="progress-container">
                ❤️<div id="feelBar" class="feel-bar">0%</div>
            </div>
            <div class="progress-container">
                🛡️<div id="defenseBar" class="defense-bar">0%</div>
            </div>
            <meter class="twelve columns" id="meter" style="margin-left: 0px; margin-top:5px;display: none;" min="0"
                    max="120" value="120"></meter>
            <div id="options" class="row">
                <div id="showSceneInfo" class="four columns option">
                    <span>>>场景描述</span>
                </div>
                <div id="showSubGoals" class="four columns option">
                    <span >>>攻略提示</span>
                </div>
                <div id="showFlurtImgs" class="four columns option">
                    <span >>>私房探花</span>
                </div>
            </div>
            <!-- <div style="width: 425px;height: 250px;position: fixed; top: 60px;"> -->
                <!-- <img src="../img/cyber_rain.gif" style="width: 413px;margin: 6px;border-radius: 10px;opacity: 0.5;" /> -->
            <!-- </div> -->
            <div id="chatbox" class="row"></div>
            <div class="row" style="display: flex; justify-content: center; align-items: center;">                
                <span id="status" style="font-size: 14px;float: left;color: RGB(200,200,200);color:red;">⬤</span>
                <input id="say" style="width: 75%;line-height: 30px; margin: 10px 10px 15px 10px;padding-left: 10px;" />
                <!-- <textarea id="say" style="display: inline;width: 80%;max-height: 45px;"></textarea> -->
                <img id="sendMessage" src="../img/send.png" style="width: 30px;margin: 5px 0 5px 0;"/>
                <button id="retrieveMessage"
                style="height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>加载会话id</button>
            <button id="loadmessages"
                style="float:left;height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>加载上次聊天</button>
            <button id="copyButton"
                style="float:left;height:45px;line-height: 24px;margin: 0 5px 0 5px;padding: 0 10px;font-size: 14px;color: rgb(150,150,150);border:none;display: none;">>复制会话id</button>
            </div>
            
            <div class="row">
                <span id="session" style="font-size: 14px;float: left;color: RGB(200,200,200);margin-right: 50px;display: none;"></span>
            </div>
            <!--</div>-->
        </div>
    </div>
    <div id="optionsModal" class="optionsModal" style="display: none;">
        <div class="options-modal-content">
            <div id="modalContent"></div>
            <span class="intro-close"
                style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;">朕知道了</span>
        </div>
    </div>
    <div id="menusModal" class="menusModal" style="display: none;">
        <div class="menus-modal-content">
            <div id="RBtnGroup0" class="row">
                <span id="newLove" style="margin: 0 10px; color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;">♥ </span>新的爱恋<span style="color: pink;"> ♥</span></span>
                <span class="love-continue" style="margin: 0 10px; color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;">  </span>再续前缘<span style="color: pink;"> 💃 </span></span>
            </div>

            <!-- 第一个optionGroup -->
            <div id="RBtnGroup1st" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option11" name="optionGroup1" value="11">
                    <label for="option11">随机场景模式</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option12" name="optionGroup1" value="12" class="auto-uncheck" >
                    <label for="option12">自定义场景模式</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option13" name="optionGroup1" value="13" class="auto-uncheck">
                    <label for="option13"><span style="color: red;">♥ </span>故事模式<span style="color: red;"> ♥</span></label>
                </div>
                <button id="Next1st" style="color:pink;">下一步</button>
            </div>

            <!-- 第二个optionGroup -->
            <div id="RBtnGroup2nd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option21" name="optionGroup2" value="21">
                    <label for="option21">邻家小妹</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option22" name="optionGroup2" value="22">
                    <label for="option22">高冷女神</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option23" name="optionGroup2" value="23">
                    <label for="option23">傲娇公主</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option24" name="optionGroup2" value="24" class="auto-uncheck">
                    <label for="option24">魅魔</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option25" name="optionGroup2" value="25" class="auto-uncheck">
                    <label for="option25">娼鬼</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option26" name="optionGroup2" value="26" class="auto-uncheck">
                    <label for="option26">花伎</label>
                </div>
                <button id="Next2nd" style="color:pink;">下一步</button>
            </div>

            <!-- 第三个optionGroup -->
            <div id="RBtnGroup3rd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option31" name="optionGroup3" value="31" class="auto-uncheck">
                    <label for="option31">轻松交谈</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option32" name="optionGroup3" value="32">
                    <label for="option32">普通拉扯</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option33" name="optionGroup3" value="33" class="auto-uncheck">
                    <label for="option33">搭讪达人</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option34" name="optionGroup3" value="34" class="auto-uncheck">
                    <label for="option34">阿鼻地狱</label>
                </div>
            </div>

            <div id="RBtnGroup3rd" class="row radio-button-group" style="display: none;">
                <div class="radio-button">
                    <input type="radio" id="option31" name="optionGroup3" value="31" class="auto-uncheck">
                    <label for="option31">轻松交谈</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option32" name="optionGroup3" value="32">
                    <label for="option32">普通拉扯</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option33" name="optionGroup3" value="33" class="auto-uncheck">
                    <label for="option33">搭讪达人</label>
                </div>
                <div class="radio-button">
                    <input type="radio" id="option34" name="optionGroup3" value="34" class="auto-uncheck">
                    <label for="option34">阿鼻地狱</label>
                </div>
            </div>

            <div class="row">
                <label id="loveLoading"></label>
            </div>
            <div class="row">
                <span id="modeInfo"></span>
            </div>
            <div class="row">
                <span id="actorInfo"></span>
            </div>
            <div class="row">
                <span id="difficultyInfo"></span>
            </div>
            <div class="row">
                <span id="menuWarning" style="color: red;"></span>
            </div>

            <div id="RBtnGroup4th" class="row" style="display: none;">
                <br/>
                <lable id="fakeLoading" style="color: white;" >启动中...</lable>
            </div>

            <div class="row love-go-div" style="margin-top: 50px;display: none;">
                <span class="love-go" style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;"><span style="color: pink;"> ♥ ♥ ♥ </span>恋爱启动<span style="color: pink;"> ♥ ♥ ♥ </span></span>
            </div>
            <div class="scrolling-wrapper" style="height: 100%; position: absolute;top:0;left:0;z-index: -999;">
                <img src="../img/danger.jpg" class="scrolling-image scroll" alt="Scrolling Image" >
            </div>
            <div class="row" style="position: fixed; bottom: 10px;width: 80%;margin: auto;">
                <span>@Copyright www.cg8.pro</span><br/>
                <span>Powered by OpenAI GPTs</span>
            </div>
        </div>
    </div>
    <div id="gameReportModal" class="gameReportModal" style="display: none;">
        <div class="game-report-modal-content">
            <div id="opinionsReport">
            </div>
            <span class="intro-close" onclick="location.reload()"
                style="color: white;border: 1px solid white;padding: 8px;border-radius: 10px;cursor:pointer;">重生</span>
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/forge.min.js"></script>
    <script src="../js/vconsole.min.js"></script>
    <script>
        var vConsole = new window.VConsole();

        var remote = 'https://cpltsbiz.azurewebsites.net/api/cplts/';
        var countdown;
        var seconds = 120;

        var playMode = "";
        var playActor = "";
        var playDifficulty = "";

        var scene = '';
        var feel = 0;
        var defense = 0;
        var goal = '';
        var leftTry = 0;
        var maxTry = 0;
        var ladyFirst = '';
        var girlTalk = '';
        var isSuccess = '';
        var opinions = [];

        var messages = [];

        const fakeBehavior = [
            "构建恋爱交互场景...",
            "清理系统缓存...",
            "装载性格特征...",
            "构建心里防御...",
            "初始化世界观...",
            "绘制私密场景...",
            "装载人工智能干涉器...",
            "卸载魅魔失控禁制...",
            "初始化阿黑颜发生器...",
            "加载步兵高清局部画质...",
            "启动性格崩裂加速器...",
            "加载雄性罐装材料...",
            "屏蔽娼鬼崩溃性格模型...",
            "向恋爱引擎投射泡学映射...",
            "向恋爱引擎投射捞女心理学映射..."
        ];

        var textarea = document.getElementById("say");
        var enterGuide = document.getElementById("enterGuide")
        var sendMessage = document.getElementById("sendMessage")
        var retrieveMessage = document.getElementById("retrieveMessage")
        var currentsession = document.getElementById("session");
        var session = getCookie("CHATGPTOLID");
        var loadmessages = document.getElementById("loadmessages")
        var modalContent = document.getElementById("modalContent")
        //var testBtn = document.getElementById("testButton")
        var optionsModal = document.getElementById('optionsModal');
        var menusModal = document.getElementById('menusModal')
        var gameReportModal = document.getElementById('gameReportModal');
        var introCloseBtn = document.getElementsByClassName('intro-close')[0];
        var loveGoBtn = document.getElementsByClassName('love-go')[0];
        var loveGoDiv = document.getElementsByClassName('love-go-div')[0]
        var loveContinueBtn = document.getElementsByClassName('love-continue')[0];
        var showSceneInfo = document.getElementById('showSceneInfo');
        var chatbox = document.getElementById("chatbox");
        var newLove = document.getElementById("newLove");
        var rBtnGroup0 = document.getElementById("RBtnGroup0");
        var rBtnGroup1st = document.getElementById("RBtnGroup1st");
        var rBtnGroup2nd = document.getElementById("RBtnGroup2nd");
        var rBtnGroup3rd = document.getElementById("RBtnGroup3rd");
        var rBtnGroup4th = document.getElementById("RBtnGroup4th");
        var next1st = document.getElementById("Next1st");
        var next2nd = document.getElementById("Next2nd");
        var fakeLoading = document.getElementById("fakeLoading");
        var opinionsReport = document.getElementById("opinionsReport");

        const rdm1 = Math.floor(Math.random() * 12) + 1;
        var boyAvatarPath = '../img/avatar/boy' + rdm1 + '.jpg';
        const rdm2 = Math.floor(Math.random() * 12) + 1;
        var girlAvatarPath = '../img/avatar/girl' + rdm2 + '.jpg';

        window.onload = function () {
            echo();
            setInterval(() => {
                echo();
            }, 10000);

            chatbox.innerHTML = "";
            menusModal.style.display = 'block';
            
            showSceneInfo.addEventListener('click', (event) => {
                modalContent.innerHTML = "<strong>攻略场景：</strong>" +  scene + "<strong>目标：</strong>" + goal;
                optionsModal.style.display = 'block';
            })

            showSubGoals.addEventListener('click', (event) => {
                modalContent.innerHTML = "未授权版本";
                optionsModal.style.display = 'block';
            })

            showFlurtImgs.addEventListener('click', (event) => {
                modalContent.innerHTML = "未授权版本";
                optionsModal.style.display = 'block';
            })

            newLove.addEventListener('click', (event) => {
                rBtnGroup0.style.display = "none";
                rBtnGroup1st.style.display = "block";
            })

            next1st.addEventListener('click', (event) => {
                if(playMode == ""){
                    alert("请正确选择模式")
                } else{
                    rBtnGroup1st.style.display = "none";
                    rBtnGroup2nd.style.display = "block";
                }
            })

            next2nd.addEventListener('click', (event) => {
                if(playActor == ""){
                    alert("请正确选择性格")
                } else{
                    rBtnGroup2nd.style.display = "none";
                    rBtnGroup3rd.style.display = "block";
                    loveGoDiv.style.display = "block";
                }
            })

            loveGoBtn.onclick = async function() {
                if(playDifficulty == ""){
                    alert("请正确选择难度")
                }
                else{
                    rBtnGroup3rd.style.display = "none";
                    loveGoDiv.style.display = "none";
                    rBtnGroup4th.style.display = "block"
                    var message = { "role": "user", "content": playMode + "," + playActor + "," + playDifficulty }
                    const intervalId = setInterval(updateFakeLoading, 2500);
                    const initResult = await sendMessages(message);
                    if (initResult){
                        clearInterval(intervalId);
                        rBtnGroup4th.style.display = "none"
                        menusModal.style.display = 'none';
                        optionsModal.style.display = 'block';
                    }
                }
            }

            function updateFakeLoading() {
                const randomIndex = Math.floor(Math.random() * fakeBehavior.length);
                fakeLoading.innerHTML = `正在${fakeBehavior[randomIndex]}`;
            }

            window.onclick = function (event) {
                if (event.target == optionsModal) {
                    optionsModal.style.display = 'none';
                }
            }

            // 点击关闭按钮或者模态框外部时，关闭模态框
            introCloseBtn.onclick = function () {
                optionsModal.style.display = 'none';
                gameReportModal.style.display = 'none';
            }

            // loveGoBtn.onclick = function () {
            //     console.log(getSelectedOptions())
            // }


            loveContinueBtn.onclick = function() {
                var menuWarning = document.getElementById('menuWarning');
                menuWarning.innerHTML = '<strong style="color:red">恋爱时空回廊还未对你开放</strong>';
            }

            var radios1 = document.getElementsByName('optionGroup1');
            var radios2 = document.getElementsByName('optionGroup2');
            var radios3 = document.getElementsByName('optionGroup3');
            Array.prototype.forEach.call(radios1, function(radio) {
                radio.addEventListener('change', radioChanged);
            });
            Array.prototype.forEach.call(radios2, function(radio) {
                radio.addEventListener('change', radioChanged);
            });
            Array.prototype.forEach.call(radios3, function(radio) {
                radio.addEventListener('change', radioChanged);
            });

            // message1 = { "role": "user", "content": "111" }
            // message2 = { "role": "assistant", "content": "111" }
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // messages.push(message1)
            // messages.push(message2)
            // fillChatbox(messages);

            const isMobile = getDeviceType() == "mobile";
            //enterGuide.style.display = isMobile ? "none" : "inline";
            //sendMessage.style.display = isMobile ? "inline" : "none";
            //retrieveMessage.style.display = isMobile ? "inline" : "none";
        }

        loadmessages.addEventListener('click', (event) => {
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "1",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                    "session": session
                })
            })
            .then(response => response.json())
            .then(data => {
                //countdownLable.style.display = "none"
                // meter.style.display = "none"
                //countdownLable.innerHTML = seconds;
                seconds = 120;
                stopCountdown();
                if (data.cptCnt == 0) {
                    messages.pop();
                } else {
                    messages.length = 0;
                    currentsession.innerHTML = session
                    JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                        messages.push(item);
                    })
                    // console.log(messages)
                    fillChatbox(messages)
                    setTimeout(function () {
                        chatbox.scrollTop = chatbox.scrollHeight;
                    }, 0);
                }
            })
            .catch(error => {
                console.error(error);
            });
        })

        sendMessage.addEventListener('click', sendMessageHandler);
        
        function sendMessageHandler(){
            //var countdownLable = document.getElementById("countdownLable")
            var meter = document.getElementById("meter")
            //countdownLable.style.display = "block"
            // meter.style.display = "block"
            //countdownLable.innerHTML = seconds;
            startCountdown();

            event.preventDefault();
            message = { "role": "user", "content": textarea.value }
            messages.push(message)
            textarea.value = ""
            fillChatbox(messages);
            setTimeout(function () {
                chatbox.scrollTop = chatbox.scrollHeight;
            }, 0);
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "7",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(message))),
                    "session": currentsession.innerHTML
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // console.log(data)
                    if (data.cptCnt == 0) {
                        messages.pop();
                    } else {
                        currentsession.innerHTML = data.session
                        if (!getCookie("CHATGPTOLID")) {
                            document.cookie = "CHATGPTOLID=" + data.session + "; path=/";
                        }

                        messages = messages.concat(JSON.parse(decrypt(key, iv, data.message)))
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        }

        retrieveMessage.addEventListener('click', () => {
            //var countdownLable = document.getElementById("countdownLable")
            var meter = document.getElementById("meter")
            //countdownLable.style.display = "block"
            // meter.style.display = "block"
            //countdownLable.innerHTML = seconds;
            startCountdown();

            event.preventDefault();
            fillChatbox(messages);
            fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "1",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                    "session": textarea.value
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // console.log(data)
                    if (data.cptCnt == 0) {
                        messages.pop();
                    } else {
                        messages.length = 0;
                        currentsession.innerHTML = textarea.value
                        document.cookie = "CHATGPTOLID=" + textarea.value + "; path=/";
                        JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                            messages.push(item);
                        })
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    }
                })
                .catch(error => {
                    console.error(error);
                });
        })

        // testBtn.addEventListener('click', () => {
        //     fetch(remote , {
        //         method: 'POST',
        //         headers: {
        //             'Content-Type': 'application/json'                        
        //         },
        //         body: JSON.stringify({
        //             "option": "41",
        //             "imgdesc":"something very cool",
        //             "session": "dalle3 test"
        //         })
        //     })
        //         .then(response => console.log(response))
        //         .catch(error => {
        //             console.error(error);
        //         });
        // })

        textarea.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && event.ctrlKey) {
                //var countdownLable = document.getElementById("countdownLable")
                var meter = document.getElementById("meter")
                //countdownLable.style.display = "block"
                // meter.style.display = "block"
                //countdownLable.innerHTML = seconds;
                startCountdown();
                event.preventDefault(); 

                var message = { "role": "user", "content": textarea.value }
                sendMessages(message);                    
            }
            if (event.key === 'Enter' && event.altKey) {
                //var countdownLable = document.getElementById("countdownLable")
                var meter = document.getElementById("meter")
                //countdownLable.style.display = "block"
                // meter.style.display = "block"
                //countdownLable.innerHTML = seconds;
                startCountdown();

                event.preventDefault();
                fillChatbox(messages);
                fetch(remote , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        
                    },
                    body: JSON.stringify({
                        "option": "1",
                        "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify([]))),
                        "session": textarea.value
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        //countdownLable.style.display = "none"
                        // meter.style.display = "none"
                        //countdownLable.innerHTML = seconds;
                        seconds = 120;
                        stopCountdown();

                        // console.log(data)
                        if (data.cptCnt == 0) {
                            messages.pop();
                        } else {
                            messages.length = 0;
                            currentsession.innerHTML = textarea.value
                            document.cookie = "CHATGPTOLID=" + textarea.value + "; path=/";
                            JSON.parse(decrypt(key, iv, data.message)).forEach(item => {
                                messages.push(item);
                            })
                            fillChatbox(messages)
                            textarea.value = ''
                            setTimeout(function () {
                                chatbox.scrollTop = chatbox.scrollHeight;
                            }, 0);
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        });
        document.querySelector("#copyButton").addEventListener('click', function () {
            copySpanTextToClipboard('session');
        });

        async function sendMessages(message) {
            messages.push(message)
            textarea.value = "";
            if(messages.length == 1){
                messages.splice(0,1);
            }
            fillChatbox(messages);
            setTimeout(function () {
                chatbox.scrollTop = chatbox.scrollHeight;
            }, 0);
            await fetch(remote , {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    
                },
                body: JSON.stringify({
                    "option": "7",
                    "messages": encrypt(key, iv, new TextEncoder().encode(JSON.stringify(message))),
                    "session": currentsession.innerHTML,
                    "asst": "asst_EB53dezUxmfLtC3nXv9y7IXK"
                })
            })
                .then(response => response.json())
                .then(data => {
                    //countdownLable.style.display = "none"
                    // meter.style.display = "none"
                    //countdownLable.innerHTML = seconds;
                    seconds = 120;
                    stopCountdown();

                    // if (data.cptCnt == 0) {
                    //     messages.pop();
                    // } else {
                        currentsession.innerHTML = data.session
                        if (!getCookie("CHATGPTOLID")) {
                            document.cookie = "CHATGPTOLID=" + data.session + "; path=/";
                        }
                        console.log(data.message)
                        messages = messages.concat(JSON.parse(decrypt(key, iv, data.message)))
                        // console.log(messages)
                        fillChatbox(messages)
                        textarea.value = ''
                        setTimeout(function () {
                            chatbox.scrollTop = chatbox.scrollHeight;
                        }, 0);
                    // }
                })
                .catch(error => {
                    console.error(error);
                });
                return true;
        }

        function fillChatbox(messages) {
            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML = "";
            messages.forEach(msg => {
                const msgLine = document.createElement('div');
                msgLine.classList.add('msgLine');
                const msgtext = document.createElement('div');
                msgtext.style = "text-align:left;"
                const contentBlocks = parseContent(msg.content, msg.role);
                contentBlocks.forEach(block => {
                    if (block.type === 'img'){
                        // 渲染图片
                        const img = document.createElement('img');
                        img.src = block.content;
                        img.style = "width:360px;height:360px;display:block;border: 3px solid gray;border-radius: 15px;margin-bottom:15px;";
                        msgtext.appendChild(img);
                    } else if (block.type === 'gpt_op_prompt' || block.type === 'dalle_op_prompt'){
                        // 优化后的提示词文本块
                        const span = document.createElement('span');
                        span.style = "display:block;"
                        span.innerHTML = block.content;
                        msgtext.appendChild(span);
                    } else if (block.type === 'code') {
                        // 渲染代码块 
                        // const pre = document.createElement('pre');
                        // const code = document.createElement('code');
                        // pre.style.color = 'black';
                        // code.textContent = block.content;
                        // pre.appendChild(code);

                        var jsonObj = JSON.parse(block.content);
                        // console.log(jsonObj)
                        const text = document.createElement('text');
                        if(scene == ''){
                            leftTry = +jsonObj.maxTry;
                            maxTry = +jsonObj.maxTry;
                            scene = jsonObj.scene;
                            goal = jsonObj.goal;
                            ladyFirst = jsonObj.ladyFirst;
                            text.textContent = ladyFirst;
                            modalContent.innerHTML = "<strong>攻略场景：</strong>" +  scene + "<strong>目标：</strong>" + goal;
                            if(ladyFirst == "" || ladyFirst == undefined){
                                ladyFirst = "..."
                            }
                            msgtext.appendChild(text)
                        } else {
                            leftTry = +jsonObj.leftTry;
                            if(jsonObj.girlTalk == undefined){
                                girlTalk = ladyFirst;
                            } else if (jsonObj.girlTalk != "" || jsonObj.girlTalk != undefined) {
                                girlTalk = jsonObj.girlTalk;
                            } else {
                                girlTalk = "..."
                            }
                            text.textContent = girlTalk;
                            msgtext.appendChild(text)
                        }
                        updateBar(parseInt(leftTry),parseInt(maxTry),"hpBar")
                        feel = +jsonObj.feel;
                        updateBar(parseInt(feel),100,"feelBar")
                        defense = +jsonObj.defense;
                        updateBar(parseInt(defense),100,"defenseBar")

                        // 游戏结束逻辑
                        if(jsonObj.isSuccess != undefined){
                            isSuccess = jsonObj.isSuccess;
                            opinions = jsonObj.opinions;
                            textarea.disabled = true;
                            sendMessage.removeEventListener('click', sendMessageHandler)

                            opinions.forEach(opinion => {
                                const opinionDiv = document.createElement('div');
                                opinionDiv.classList.add('row');
                                const boyLine = document.createElement('span');
                                boyLine.classList.add('row')
                                boyLine.style.color = 'white';
                                boyLine.innerHTML = opinion.words;
                                const advice = document.createElement('span');
                                advice.classList.add('row');
                                advice.style.color = 'yellow';
                                advice.innerHTML = opinion.opinion;
                                const can = document.createElement('span');
                                can.classList.add('row');
                                can.style.color = 'lightblue';
                                can.innerHTML = opinion.can;

                                opinionDiv.appendChild(boyLine);
                                opinionDiv.appendChild(advice);
                                opinionDiv.appendChild(can);
                                opinionsReport.appendChild(opinionDiv);
                            })

                            gameReportModal.style.display = 'block';
                        }
                    } else {
                        const span = document.createElement('span');
                        span.innerHTML = block.content;
                        msgtext.appendChild(span);
                    }
                });

                const img = document.createElement('img');

                if (msg.role === 'user') {
                    img.src = boyAvatarPath;
                    img.style = "width:40px;margin:5px 5px;float:right;border-radius:5px;";
                    msgLine.appendChild(img);
                    msgLine.appendChild(msgtext)
                    msgtext.classList.add('user-msg');
                } else if (msg.role === 'assistant') {
                    img.src = girlAvatarPath;
                    img.style = "width:40px;margin:5px 5px;float:left;border-radius:5px;";
                    msgLine.appendChild(img);
                    msgLine.appendChild(msgtext)
                    msgtext.classList.add('assistant-msg');
                }
                
                chatbox.appendChild(msgLine)
            });
        }

        function parseContent(content,role) {
            let blocks = [];
            let lines = content.split('\n');
            let inCode = false;
            let text = '';
            let code = '';
            if(role === "user"){
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    if (line.startsWith('[image]')) {
                        // DALLE3 图片

                        // 匹配Image URL
                        let imageRegex = /\[image\](.*?)\[gpt_prompt\]/;
                        let imageUrl = line.match(imageRegex)[1];

                        // 匹配DALL·E Prompt
                        // let gptPromptRegex = /\[gpt_prompt\](.*)/;
                        // let gptPrompt = line.match(gptPromptRegex)[1];

                        // // 匹配GPT Prompt
                        let gptPromptRegex = /\[gpt_prompt\](.*?)\[dalle_prompt\]/;
                        let gptPrompt = line.match(gptPromptRegex)[1];

                        // // 匹配DALL·E Prompt
                        let dallePromptRegex = /\[dalle_prompt\](.*)/;
                        let dallePrompt = line.match(dallePromptRegex)[1];

                        blocks.push({ type: 'img', content: imageUrl})
                        blocks.push({ type: 'gpt_op_prompt', content: 'ChatGPT 改写的提示词：' + gptPrompt})
                        blocks.push({ type: 'dalle_op_prompt', content: 'DALLE 优化的提示词：' + dallePrompt})

                    } else if (line.startsWith('```') && !inCode) {
                        // 文本块结束或代码块开始
                        if (text) {
                            blocks.push({ type: 'text', content: text });
                            text = '';
                        }
                        inCode = !inCode;
                    } else if (line.endsWith('```') && inCode) {
                        // 代码块结束
                        inCode = false;
                        blocks.push({ type: 'code', content: code });
                        code = '';
                    } else {
                        if (inCode) {
                            // 积累代码内容
                            code += line + '\n';
                        } else {
                            // 积累文本内容  
                            text += line + '\n';
                        }
                    }
                }
            } else {
                for (let i = 0; i < lines.length; i++) {
                    let line = lines[i];
                    if (line.startsWith('[image]')) {
                        // DALLE3 图片

                        // 匹配Image URL
                        let imageRegex = /\[image\](.*?)\[gpt_prompt\]/;
                        let imageUrl = line.match(imageRegex)[1];

                        // 匹配DALL·E Prompt
                        // let gptPromptRegex = /\[gpt_prompt\](.*)/;
                        // let gptPrompt = line.match(gptPromptRegex)[1];

                        // // 匹配GPT Prompt
                        let gptPromptRegex = /\[gpt_prompt\](.*?)\[dalle_prompt\]/;
                        let gptPrompt = line.match(gptPromptRegex)[1];

                        // // 匹配DALL·E Prompt
                        let dallePromptRegex = /\[dalle_prompt\](.*)/;
                        let dallePrompt = line.match(dallePromptRegex)[1];

                        blocks.push({ type: 'img', content: imageUrl})
                        blocks.push({ type: 'gpt_op_prompt', content: 'ChatGPT 改写的提示词：' + gptPrompt})
                        blocks.push({ type: 'dalle_op_prompt', content: 'DALLE 优化的提示词：' + dallePrompt})

                    } else if (line.startsWith('```') && !inCode) {
                        // 文本块结束或代码块开始
                        if (text) {
                            blocks.push({ type: 'text', content: text });
                            text = '';
                        }
                        inCode = !inCode;
                    } else if (line.endsWith('```') && inCode) {
                        // 代码块结束
                        inCode = false;
                        blocks.push({ type: 'code', content: code });
                        code = '';
                    } else {
                        if (inCode) {
                            // 积累代码内容
                            code += line + '\n';
                        } else {
                            // 积累文本内容  
                            // text += line + '\n';
                        }
                    }
                }
            }
            
            // 收尾 
            if (text)
                blocks.push({ type: 'text', content: text });
            return blocks;
        }

        function showGameResult(){
            gameReportModal.style.display = 'block';
            if(isSuccess == "true"){
                opinions.innerHTML = '<span style="color:lightgreen">攻略成功！</span>'
            } else {
                opinions.innerHTML = '<span style="color:red">攻略失败！</span>'
            }
        }

        function copySpanTextToClipboard(spanId) {
            var span = document.getElementById(spanId);
            var text = span.textContent;
            var tempTextarea = document.createElement('textarea');
            tempTextarea.style = "position: absolute; left: -1000px; top: -1000px";
            tempTextarea.value = text;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);
            if (text.length > 0) {
                alert("会话id已复制到剪贴板")
            }
        }
        
        function startCountdown() {
            countdown = setInterval(function () {
                seconds--;
                $('#meter')[0].value = seconds;
                //$("#countdownLable").html(seconds);
                if (seconds <= 0) {
                    clearInterval(countdown);
                }
            }, 1000);
        }

        function stopCountdown() {
            clearInterval(countdown);
            $('#countdown').text('倒计时结束');
        }

        function getCookie(name) {
            var cookies = document.cookie.split("; ");
            for (var i = 0; i < cookies.length; i++) {
                var cookie = cookies[i].split("=");
                if (cookie[0] === name) {
                    return cookie[1];
                }
            }
            return false;
        }

        function getDeviceType() {
            const userAgent = navigator.userAgent;
            if (/Mobile|iPod/i.test(userAgent)
                || /Android/i.test(userAgent) && !/Mobile/i.test(userAgent)) {
                return "mobile";
            } else {
                return "desktop";
            }
        }

        function updateBar(currentValue, maxValue, barId) {
            var progressBar = document.getElementById(barId);
            var width = (currentValue / maxValue) * 370;
            progressBar.style.width = width + 'px'; // 设置宽度
            progressBar.textContent = currentValue; // 显示文字
        }

        function getSelectedOptions() {
            var selectedOptions = {};
            var groups = ['optionGroup1', 'optionGroup2', 'optionGroup3'];
            groups.forEach(function(group) {
                var selectedRadio = document.querySelector(`input[name="${group}"]:checked`);
                selectedOptions[group] = selectedRadio ? selectedRadio.value : null;
            });
            return selectedOptions;
        }

        function radioChanged(event) {
            var radioId = event.target.id;
            var modeInfo = document.getElementById('modeInfo');
            var actorInfo = document.getElementById('actorInfo');
            var difficultyInfo = document.getElementById('difficultyInfo');
            var menuWarning = document.getElementById('menuWarning');

            // 如果该单选按钮应该取消选中
            if (event.target.classList.contains('auto-uncheck')) {
                setTimeout(function() { // 使用 setTimeout 来延迟取消选中
                    event.target.checked = false;
                }, 0);
                // if(event.target.value.startsWith('1')){
                //     menuWarning.innerHTML = "未授权模式不支持该模式";
                // }
                // if(event.target.value.startsWith('2')){
                //     menuWarning.innerHTML = "未授权模式不支持该性格设定";
                // }
                // if(event.target.value.startsWith('3')){
                //     menuWarning.innerHTML = "未授权模式不支持难度选择";
                // }
                
            }
            menuWarning.innerHTML = "";
            // 根据选中的单选按钮，显示相应的信息
            switch(event.target.value) {
                case '11':
                    modeInfo.innerHTML = '<strong style="color:gold">随机场景模式</strong>：全垒训练大师随机生成搭讪场景';
                    playMode = "随机场景模式";
                    break;
                case '12':
                    modeInfo.innerHTML = '<strong style="color:gold">自定义场景模式</strong>：尽可能详细的输入你现实追求对象的细节，全垒训练大师会模拟其行为，与你展开模拟实战训练。<strong style="color:red">当前未授权，不支持选择</strong>';
                    //playMode = "自定义场景模式";
                    playMode = ""
                    break;
                case '13':
                    modeInfo.innerHTML = '<strong style="color:gold">故事模式</strong>：开展一场真实的拟真追求体验，尽可能详细的输入你现实追求对象的细节，全垒训练大师会模拟其行为，与你展开模拟实战训练。<strong style="color:red">当前未授权，不支持选择该模式</strong>';
                    //playMode = "故事模式";
                    playMode = ""
                    break;
                case '21':
                    actorInfo.innerHTML = '<strong style="color:gold">邻家小妹性格：</strong>“今天也去图书馆一起学习吗？”';
                    playActor = "邻家小妹";
                    break;
                case '22':
                    actorInfo.innerHTML = '<strong style="color:gold">高冷女神性格：</strong>“你算是个什么东西？”';
                    playActor = "高冷女神";
                    break;
                case '23':
                    actorInfo.innerHTML = '<strong style="color:gold">傲娇公主性格：</strong>“追求我的人，可是排着队呢！”';
                    playActor = "傲娇公主";
                    break;
                case '24':
                    actorInfo.innerHTML = '<strong style="color:gold">魅魔性格：</strong>“宝贝，跪下~”.<strong style="color:red">当前不支持选择</strong>';
                    //playActor = "魅魔";
                    playActor = ""
                    break;
                case '25':
                    actorInfo.innerHTML = '<strong style="color:gold">娼鬼性格：</strong>“臭东西，这样就不行了？”.<strong style="color:red">当前不支持选择</strong>';
                    //playActor = "娼鬼";
                    playActor = ""
                    break;
                case '26':
                    actorInfo.innerHTML = '<strong style="color:gold">花伎性格：</strong>“要欣赏妾身的舞姿吗？”.<strong style="color:red">当前不支持选择</strong>';
                    //playActor = "花伎";
                    playActor = ""
                    break;
                case '31':
                    difficultyInfo.innerHTML = '<strong style="color:gold">轻松交谈：</strong>“对本殿而言毫无难度”.<strong style="color:red">当前不支持选择</strong>';
                    //playDifficulty = "轻松";
                    playDifficulty = ""
                    break;
                case '32':
                    difficultyInfo.innerHTML = '<strong style="color:gold">普通拉扯：</strong>“这小妮推拉功夫了得，不太好搞”';
                    playDifficulty = "普通";
                    break;
                case '33':
                    difficultyInfo.innerHTML = '<strong style="color:gold">搭讪达人：</strong>“本王眼中没有难搞的对象”.<strong style="color:red">当前不支持选择</strong>';
                    //playDifficulty = "达人";
                    playDifficulty = ""
                    break;         
                case '34':
                    difficultyInfo.innerHTML = '<strong style="color:gold">阿鼻地狱：</strong>“江湖路远，劝大侠重新来过”.<strong style="color:red">当前不支持选择</strong>';
                    //playDifficulty = "地狱";
                    playDifficulty = ""
                    break;           
            }
        }

        function echo() {
            const currentsession = document.getElementById("status");
            fetch(remote , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        "option": "0",
                    })
                })
                .then(response => {
                    if (!response.ok || response.status < 200 || response.status > 299){
                        currentsession.innerHTML = "⬤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:red;"
                    }
                    return response;
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status == "ok") {
                        currentsession.innerHTML = "⬤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:green;"
                    } else {
                        currentsession.innerHTML = "⬤"
                        currentsession.style = "font-size: 14px;float: left;color: RGB(200,200,200);color:red;"
                    }
                })
                .catch(error => {
                    console.error(error);
                }
            );
        }

        const key = "i9r8RSYSlIHjPv5EX+LTZ4b8XMvr1FMgjZYlI0uDzvg="
        const iv = "9iebtE3ryRW8CrVCI08psA=="

        // 加密
        function encrypt(keyBase64, ivBase64, data) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var cipher = forge.cipher.createCipher('AES-CBC', key);
            cipher.start({ iv: iv });
            cipher.update(forge.util.createBuffer(data));
            cipher.finish();
            var encrypted = cipher.output;
            return forge.util.encode64(encrypted.getBytes());
        }

        // 解密
        function decrypt(keyBase64, ivBase64, encryptedData) {
            var key = forge.util.decode64(keyBase64);
            var iv = forge.util.decode64(ivBase64);
            var decipher = forge.cipher.createDecipher('AES-CBC', key);
            decipher.start({ iv: iv });
            decipher.update(forge.util.createBuffer(forge.util.decode64(encryptedData)));
            decipher.finish();
            return decipher.output.data;
        }
    </script>
</body>

</html>